<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Business Intelligence | Construction Analytics</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --primary-light: #a5b4fc;
      --secondary: #0ea5e9;
      --success: #10b981;
      --success-light: #d1fae5;
      --warning: #f59e0b;
      --warning-light: #fef3c7;
      --danger: #ef4444;
      --danger-light: #fee2e2;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.04);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
      --shadow-lg: 0 12px 24px rgba(0,0,0,0.12);
      --shadow-xl: 0 20px 40px rgba(0,0,0,0.15);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #f8fafc 0%, #e0e7ff 25%, #fef3c7 50%, #dbeafe 75%, #f0fdf4 100%);
      min-height: 100vh;
      color: var(--gray-700);
      font-size: 14px;
      line-height: 1.6;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 30%, rgba(99, 102, 241, 0.08) 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(245, 158, 11, 0.08) 0%, transparent 50%),
        radial-gradient(circle at 50% 50%, rgba(14, 165, 233, 0.06) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }

    .main-container {
      position: relative;
      z-index: 1;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: var(--gray-100);
    }
    ::-webkit-scrollbar-thumb {
      background: var(--gray-300);
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: var(--gray-400);
    }

    /* Header */
    .dashboard-header {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a855f7 100%);
      position: relative;
      overflow: hidden;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 
        0 10px 40px rgba(99, 102, 241, 0.3),
        0 0 0 1px rgba(255, 255, 255, 0.2) inset;
    }

    .dashboard-header::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -20%;
      width: 60%;
      height: 200%;
      background: radial-gradient(ellipse, rgba(255, 255, 255, 0.2) 0%, transparent 70%);
      pointer-events: none;
    }

    .dashboard-header::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, 
        transparent 0%, 
        rgba(255, 255, 255, 0.8) 25%,
        rgba(245, 158, 11, 0.8) 50%,
        rgba(255, 255, 255, 0.8) 75%,
        transparent 100%);
    }

    .header-content {
      position: relative;
      z-index: 1;
      padding: 1rem 0;
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 2rem;
      margin-bottom: 0.5rem;
    }

    .logo-section {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .logo-section img {
      height: 44px;
      background: white;
      padding: 6px 12px;
      border-radius: var(--radius-sm);
    }

    .header-meta {
      display: flex;
      align-items: center;
      gap: 2rem;
      color: rgba(255,255,255,0.9);
      font-size: 0.85rem;
    }

    .header-meta i {
      margin-right: 6px;
      opacity: 0.8;
    }

    .header-main {
      text-align: center;
      color: white;
      padding: 0.5rem 2rem 1rem;
    }

    .header-main h1 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
    }

    .header-main h1 i {
      font-size: 1.5rem;
      opacity: 0.9;
    }

    .header-main .subtitle {
      opacity: 0.85;
      font-size: 0.95rem;
      font-weight: 400;
    }

    /* Main Container */
    .main-container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 1rem;
    }

    /* Tab Navigation */
    .tab-navigation {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(20px);
      padding: 0.75rem;
      border-radius: var(--radius-lg);
      box-shadow: 
        0 8px 32px rgba(99, 102, 241, 0.1),
        0 2px 8px rgba(0, 0, 0, 0.05),
        0 0 0 1px rgba(99, 102, 241, 0.08) inset;
      border: 1px solid rgba(255, 255, 255, 0.8);
    }

    .tab-button {
      flex: 1;
      padding: 0.75rem 1.5rem;
      border: none;
      background: transparent;
      color: var(--gray-600);
      border-radius: var(--radius-md);
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      position: relative;
    }

    .tab-button:hover {
      background: rgba(99, 102, 241, 0.08);
      color: var(--primary);
    }

    .tab-button.active {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      color: white;
      box-shadow: 
        0 4px 16px rgba(99, 102, 241, 0.4),
        0 0 0 1px rgba(255, 255, 255, 0.3) inset;
    }

    .tab-button.active::after {
      content: '';
      position: absolute;
      bottom: -0.75rem;
      left: 50%;
      transform: translateX(-50%);
      width: 40px;
      height: 3px;
      background: linear-gradient(90deg, transparent, #6366f1, transparent);
      border-radius: 2px;
    }

    .tab-button i {
      font-size: 1.1rem;
    }

    /* Tab Content */
    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    /* Cards */
    .card {
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.8);
      border-radius: var(--radius-lg);
      box-shadow: 
        0 8px 32px rgba(99, 102, 241, 0.1),
        0 2px 8px rgba(0, 0, 0, 0.05),
        0 0 0 1px rgba(99, 102, 241, 0.08) inset;
      transition: var(--transition);
      overflow: hidden;
    }

    .card:hover {
      box-shadow: 
        0 12px 48px rgba(99, 102, 241, 0.15),
        0 4px 16px rgba(0, 0, 0, 0.08),
        0 0 0 1px rgba(99, 102, 241, 0.12) inset;
      transform: translateY(-2px);
    }

    .card-header-custom {
      background: linear-gradient(135deg, var(--gray-50) 0%, white 100%);
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--gray-100);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .card-header-custom h5 {
      margin: 0;
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--gray-800);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .card-header-custom h5 i {
      color: var(--primary);
      font-size: 1.1rem;
    }

    .card-body-custom {
      padding: 1rem;
    }

    /* Upload Zone */
    .upload-section {
      margin-bottom: 1rem;
    }

    .upload-zone {
      border: 2px dashed var(--gray-300);
      border-radius: var(--radius-lg);
      padding: 2.5rem;
      text-align: center;
      background: linear-gradient(135deg, var(--gray-50) 0%, white 100%);
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .upload-zone::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(14, 165, 233, 0.05) 100%);
      opacity: 0;
      transition: var(--transition);
    }

    .upload-zone:hover,
    .upload-zone.dragover {
      border-color: var(--primary);
      transform: translateY(-2px);
    }

    .upload-zone:hover::before,
    .upload-zone.dragover::before {
      opacity: 1;
    }

    .upload-zone .icon-wrapper {
      width: 80px;
      height: 80px;
      margin: 0 auto 1rem;
      background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }

    .upload-zone:hover .icon-wrapper {
      transform: scale(1.1);
    }

    .upload-zone .icon-wrapper i {
      font-size: 2rem;
      color: white;
    }

    .upload-zone h4 {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--gray-800);
      margin-bottom: 0.5rem;
    }

    .upload-zone p {
      color: var(--gray-500);
      margin: 0;
      font-size: 0.9rem;
    }

    .upload-zone .browse-link {
      color: var(--primary);
      font-weight: 600;
      text-decoration: underline;
    }

    #csvFile {
      display: none;
    }

    /* Status Badge */
    .status-section {
      display: flex;
      justify-content: center;
      margin-bottom: 1rem;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1.5rem;
      border-radius: 50px;
      font-size: 0.9rem;
      font-weight: 500;
      background: white;
      box-shadow: var(--shadow-md);
      color: var(--gray-600);
    }

    .status-badge .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--gray-400);
      animation: pulse 2s infinite;
    }

    .status-badge.success .status-dot {
      background: var(--success);
    }

    .status-badge.success {
      color: var(--success);
      background: var(--success-light);
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* KPI Cards */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    @media (max-width: 1200px) {
      .kpi-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 576px) {
      .kpi-grid {
        grid-template-columns: 1fr;
      }
    }

    .kpi-card {
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(20px);
      border-radius: var(--radius-lg);
      padding: 1rem;
      box-shadow: 
        0 8px 32px rgba(99, 102, 241, 0.1),
        0 2px 8px rgba(0, 0, 0, 0.05),
        0 0 0 1px rgba(99, 102, 241, 0.08) inset;
      position: relative;
      overflow: hidden;
      transition: var(--transition);
      border: 1px solid rgba(255, 255, 255, 0.8);
    }

    .kpi-card:hover {
      transform: translateY(-4px);
      box-shadow: 
        0 12px 48px rgba(99, 102, 241, 0.15),
        0 4px 16px rgba(0, 0, 0, 0.08),
        0 0 0 1px rgba(99, 102, 241, 0.12) inset;
    }

    .kpi-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
    }

    .kpi-card.primary::before { 
      background: linear-gradient(90deg, #6366f1, #8b5cf6, #a855f7); 
    }
    .kpi-card.success::before { 
      background: linear-gradient(90deg, #10b981, #34d399, #6ee7b7); 
    }
    .kpi-card.warning::before { 
      background: linear-gradient(90deg, #f59e0b, #fbbf24, #fcd34d); 
    }
    .kpi-card.danger::before { 
      background: linear-gradient(90deg, #ef4444, #f87171, #fca5a5); 
    }

    .kpi-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1rem;
    }

    .kpi-icon {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
    }

    .kpi-card.primary .kpi-icon { background: rgba(99, 102, 241, 0.1); color: var(--primary); }
    .kpi-card.success .kpi-icon { background: rgba(16, 185, 129, 0.1); color: var(--success); }
    .kpi-card.warning .kpi-icon { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
    .kpi-card.danger .kpi-icon { background: rgba(239, 68, 68, 0.1); color: var(--danger); }

    .kpi-value {
      font-size: 2rem;
      font-weight: 800;
      color: var(--gray-900);
      line-height: 1;
      margin-bottom: 0.25rem;
    }

    .kpi-label {
      font-size: 0.8rem;
      color: var(--gray-500);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 500;
    }

    .kpi-trend {
      font-size: 0.75rem;
      font-weight: 600;
      padding: 0.25rem 0.5rem;
      border-radius: 50px;
    }

    .kpi-trend.up { background: var(--success-light); color: var(--success); }
    .kpi-trend.down { background: var(--danger-light); color: var(--danger); }

    /* Filter Section */
    .filter-section {
      margin-bottom: 1rem;
    }

    .filter-toggle {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
    }

    .filter-toggle h6 {
      margin: 0;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--gray-600);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-clear-filters {
      font-size: 0.8rem;
      padding: 0.4rem 1rem;
      border-radius: 50px;
      background: var(--gray-100);
      color: var(--gray-600);
      border: none;
      cursor: pointer;
      transition: var(--transition);
    }

    .btn-clear-filters:hover {
      background: var(--danger-light);
      color: var(--danger);
    }

    .filter-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.75rem;
    }

    @media (max-width: 992px) {
      .filter-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 576px) {
      .filter-grid {
        grid-template-columns: 1fr;
      }
    }

    .filter-card {
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(20px);
      border-radius: var(--radius-md);
      box-shadow: 
        0 4px 16px rgba(99, 102, 241, 0.08),
        0 2px 6px rgba(0, 0, 0, 0.04),
        0 0 0 1px rgba(99, 102, 241, 0.06) inset;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.8);
      transition: var(--transition);
    }

    .filter-card:hover {
      box-shadow: 
        0 6px 24px rgba(99, 102, 241, 0.12),
        0 3px 10px rgba(0, 0, 0, 0.06),
        0 0 0 1px rgba(99, 102, 241, 0.1) inset;
    }

    /* Year Dropdown */
    .year-dropdown-wrapper {
      position: relative;
    }

    .year-dropdown {
      width: 100%;
      padding: 0.65rem 2.5rem 0.65rem 1rem;
      border: 2px solid var(--gray-200);
      border-radius: var(--radius-md);
      background: white;
      color: var(--gray-700);
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%236366f1' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      background-size: 14px;
    }

    .year-dropdown:hover {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .year-dropdown:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15);
    }

    .year-dropdown option {
      padding: 0.5rem;
      font-weight: 600;
    }

    .filter-card-header {
      padding: 0.75rem 1rem;
      background: var(--gray-50);
      border-bottom: 1px solid var(--gray-100);
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--gray-600);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .filter-card-header i {
      color: var(--primary);
    }

    .filter-card-body {
      padding: 0.75rem;
    }

    /* Slicers */
    .slicer {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      max-height: 120px;
      overflow-y: auto;
    }

    .slicer button {
      border: 1px solid var(--gray-200);
      background: white;
      color: var(--gray-600);
      padding: 0.35rem 0.85rem;
      border-radius: 50px;
      font-size: 0.75rem;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      white-space: nowrap;
    }

    .slicer button:hover {
      border-color: var(--primary-light);
      color: var(--primary);
      background: rgba(99, 102, 241, 0.05);
    }

    .slicer button.active {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      border-color: var(--primary);
      box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
    }

    .slicer button.dimmed {
      opacity: 0.4;
      background: var(--gray-50);
      color: var(--gray-400);
    }

    .slicer button.highlighted {
      border-color: var(--success);
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
    }

    /* Main Content Grid */
    .content-grid {
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 1rem;
    }

    @media (max-width: 1200px) {
      .content-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Funnel */
    .funnel-container {
      padding: 0.5rem 0;
    }

    .funnel-row {
      display: flex;
      align-items: center;
      margin: 0.6rem 0;
      gap: 1rem;
    }

    .funnel-label {
      min-width: 150px;
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--gray-600);
      text-align: right;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 0.5rem;
    }

    .funnel-label .stage-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .funnel-bar-container {
      flex: 1;
      height: 32px;
      background: var(--gray-100);
      border-radius: var(--radius-sm);
      overflow: hidden;
      position: relative;
    }

    .funnel-bar {
      height: 100%;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 12px;
      color: white;
      font-weight: 600;
      font-size: 0.8rem;
      transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      min-width: 40px;
      position: relative;
      overflow: hidden;
    }

    .funnel-bar::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.15) 50%, transparent 100%);
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    /* Stage Gradients */
    .stage-0 { background: linear-gradient(90deg, #7c3aed, #8b5cf6); }
    .stage-1 { background: linear-gradient(90deg, #2563eb, #3b82f6); }
    .stage-2 { background: linear-gradient(90deg, #0891b2, #06b6d4); }
    .stage-3 { background: linear-gradient(90deg, #0d9488, #14b8a6); }
    .stage-4 { background: linear-gradient(90deg, #059669, #10b981); }
    .stage-5 { background: linear-gradient(90deg, #65a30d, #84cc16); }
    .stage-6 { background: linear-gradient(90deg, #ca8a04, #eab308); }
    .stage-7 { background: linear-gradient(90deg, #16a34a, #22c55e); }

    .dot-0 { background: #8b5cf6; }
    .dot-1 { background: #3b82f6; }
    .dot-2 { background: #06b6d4; }
    .dot-3 { background: #14b8a6; }
    .dot-4 { background: #10b981; }
    .dot-5 { background: #84cc16; }
    .dot-6 { background: #eab308; }
    .dot-7 { background: #22c55e; }

    /* Activity Table */
    .activity-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }

    .activity-table thead th {
      background: var(--gray-50);
      padding: 0.75rem 1rem;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--gray-500);
      border-bottom: 2px solid var(--gray-200);
      text-align: left;
    }

    .activity-table tbody td {
      padding: 0.85rem 1rem;
      font-size: 0.85rem;
      border-bottom: 1px solid var(--gray-100);
      vertical-align: middle;
    }

    .activity-table tbody tr {
      transition: var(--transition);
      cursor: pointer;
    }

    .activity-table tbody tr:hover {
      background: var(--gray-50);
    }

    .activity-table tbody tr.clickable:hover {
      background: rgba(99, 102, 241, 0.05);
    }

    .activity-table tbody tr:last-child td {
      border-bottom: none;
    }

    .activity-name {
      font-weight: 500;
      color: var(--gray-700);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .activity-name.clickable {
      color: var(--primary);
      cursor: pointer;
    }

    .activity-name.clickable:hover {
      text-decoration: underline;
    }

    .activity-name i.bi-hand-index {
      font-size: 0.9rem;
      opacity: 0.6;
    }

    .cell-scope {
      color: var(--gray-600);
      font-weight: 500;
    }

    .cell-complete {
      color: var(--success);
      font-weight: 600;
    }

    .cell-balance {
      background: var(--warning-light);
      color: var(--warning);
      font-weight: 600;
      border-radius: var(--radius-sm);
      padding: 0.25rem 0.5rem;
      display: inline-block;
    }

    .cell-revenue {
      background: var(--success-light);
      color: var(--success);
      font-weight: 600;
      border-radius: var(--radius-sm);
      padding: 0.25rem 0.5rem;
      display: inline-block;
    }

    .progress-mini {
      height: 4px;
      background: var(--gray-200);
      border-radius: 2px;
      margin-top: 0.5rem;
      overflow: hidden;
    }

    .progress-mini-bar {
      height: 100%;
      background: var(--success);
      border-radius: 2px;
      transition: width 0.6s ease;
    }

    /* Details Table */
    .details-section {
      margin-top: 1.5rem;
      display: none;
    }

    .details-section.visible {
      display: block;
      animation: slideDown 0.4s ease;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .details-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .details-header h5 {
      margin: 0;
      font-size: 1rem;
      font-weight: 600;
      color: var(--gray-800);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .details-header h5 i {
      color: var(--primary);
    }

    .details-header .activity-badge {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 0.4rem 1rem;
      border-radius: 50px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .btn-close-details {
      background: var(--gray-100);
      color: var(--gray-600);
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 50px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-close-details:hover {
      background: var(--danger-light);
      color: var(--danger);
    }

    .btn-download-excel {
      background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
      color: white;
      border: none;
      padding: 0.5rem 1.25rem;
      border-radius: 50px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }

    .btn-download-excel:hover {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }

    .details-actions {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    /* Summary Tables Section */
    .summary-tables-section {
      margin-top: 1rem;
      display: none;
    }

    .summary-tables-section.visible {
      display: block;
      animation: fadeIn 0.5s ease;
    }

    .summary-tables-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      margin-bottom: 1rem;
    }

    @media (max-width: 1400px) {
      .summary-tables-grid {
        grid-template-columns: 1fr;
      }
    }

    .summary-table-card {
      background: white;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      overflow: hidden;
      transition: var(--transition);
    }

    .summary-table-card:hover {
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px);
    }

    .summary-table-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 1rem 1.25rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .summary-table-header.plaster {
      background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%);
    }

    .summary-table-header.flooring {
      background: linear-gradient(135deg, #0d9488 0%, #0f766e 100%);
    }

    .summary-table-header.handover {
      background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
    }

    .summary-table-header h6 {
      margin: 0;
      font-size: 0.9rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .summary-table-header i {
      font-size: 1.1rem;
    }

    .summary-table-count {
      background: rgba(255, 255, 255, 0.2);
      padding: 0.25rem 0.75rem;
      border-radius: 50px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .summary-table-body {
      padding: 0;
    }

    .summary-table {
      width: 100%;
      border-collapse: collapse;
    }

    .summary-table thead th {
      background: var(--gray-50);
      padding: 0.75rem 0.85rem;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      color: var(--gray-600);
      border-bottom: 2px solid var(--gray-200);
      text-align: left;
    }

    .summary-table tbody td {
      padding: 0.75rem 0.85rem;
      font-size: 0.8rem;
      border-bottom: 1px solid var(--gray-100);
      vertical-align: middle;
    }

    .summary-table tbody tr {
      transition: var(--transition);
    }

    .summary-table tbody tr:hover {
      background: var(--gray-50);
    }

    .summary-table tbody tr:last-child td {
      border-bottom: none;
    }

    .summary-project-name {
      font-weight: 600;
      color: var(--gray-700);
    }

    .summary-number {
      font-weight: 600;
      color: var(--gray-700);
      text-align: center;
    }

    .summary-billable {
      background: var(--success-light);
      color: var(--success);
      font-weight: 600;
      padding: 0.25rem 0.5rem;
      border-radius: var(--radius-sm);
      display: inline-block;
      min-width: 40px;
      text-align: center;
    }

    .summary-non-billable {
      background: var(--gray-100);
      color: var(--gray-600);
      font-weight: 600;
      padding: 0.25rem 0.5rem;
      border-radius: var(--radius-sm);
      display: inline-block;
      min-width: 40px;
      text-align: center;
    }

    .summary-revenue {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%);
      color: var(--success);
      font-weight: 700;
      padding: 0.35rem 0.65rem;
      border-radius: var(--radius-sm);
      text-align: center;
    }

    .summary-total-row {
      background: linear-gradient(135deg, var(--primary-light) 0%, rgba(99, 102, 241, 0.2) 100%);
      font-weight: 700;
      border-top: 2px solid var(--primary) !important;
    }

    .summary-total-row td {
      color: var(--primary);
      font-size: 0.85rem;
      padding: 1rem 0.85rem !important;
    }

    .details-table-container {
      max-height: 500px;
      overflow-y: auto;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      position: relative;
    }

    .details-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: white;
    }

    .details-table thead th {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 1rem;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      text-align: left;
      position: sticky;
      top: 0;
      z-index: 20;
      cursor: pointer;
      user-select: none;
      transition: var(--transition);
    }

    .details-table tbody .total-row {
      position: sticky;
      top: 50px;
      z-index: 15;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .details-table thead th:hover {
      background: linear-gradient(135deg, var(--primary-dark) 0%, #3730a3 100%);
    }

    .details-table thead th.sortable {
      position: relative;
      padding-right: 2rem;
    }

    .details-table thead th.sortable::after {
      content: '\F0DC';
      font-family: 'bootstrap-icons';
      position: absolute;
      right: 0.75rem;
      opacity: 0.5;
      font-size: 0.75rem;
    }

    .details-table thead th.sortable.asc::after {
      content: '\F0D8';
      opacity: 1;
    }

    .details-table thead th.sortable.desc::after {
      content: '\F0D7';
      opacity: 1;
    }

    .details-table thead th:first-child {
      border-top-left-radius: var(--radius-lg);
    }

    .details-table thead th:last-child {
      border-top-right-radius: var(--radius-lg);
    }

    .details-table tbody td {
      padding: 0.9rem 1rem;
      font-size: 0.85rem;
      border-bottom: 1px solid var(--gray-100);
      vertical-align: middle;
    }

    .details-table tbody tr {
      transition: var(--transition);
    }

    .details-table tbody tr:hover {
      background: var(--gray-50);
    }

    .details-table tbody tr:last-child td {
      border-bottom: none;
    }

    .details-table tbody tr:nth-child(even) {
      background: rgba(99, 102, 241, 0.02);
    }

    .total-row {
      background: linear-gradient(135deg, var(--success-light) 0%, #d1fae5 100%) !important;
      font-weight: 700;
      border-top: 3px solid var(--success) !important;
      border-bottom: 3px solid var(--success) !important;
    }

    .total-row td {
      color: var(--success);
      font-size: 0.95rem;
      padding: 1.2rem 1rem !important;
    }

    .total-row .total-label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .total-row .total-label i {
      font-size: 1.1rem;
    }

    .unit-number {
      font-weight: 600;
      color: var(--primary);
    }

    .customer-name {
      color: var(--gray-700);
      font-weight: 500;
    }

    .revenue-cell {
      font-weight: 600;
      color: var(--success);
    }

    /* Footer */
    .dashboard-footer {
      text-align: center;
      padding: 1.5rem 2rem 1rem;
      color: var(--gray-400);
      font-size: 0.8rem;
      margin-top: 1rem;
      position: relative;
    }

    .dashboard-footer a {
      color: var(--primary);
      text-decoration: none;
    }

    .creator-credit {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--gray-200);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      font-size: 0.85rem;
    }

    .creator-credit .creator-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, #c56a3f 0%, #b85a31 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 0.9rem;
    }

    .creator-credit .creator-text {
      color: var(--gray-600);
      font-weight: 500;
    }

    .creator-credit .creator-name {
      background: linear-gradient(135deg, #c56a3f 0%, #b85a31 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 700;
      font-size: 0.95rem;
    }

    /* Plan vs Actuals Table */
    .plan-actual-card {
      background: white;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      overflow: hidden;
      margin-bottom: 1.5rem;
    }

    .plan-actual-header {
      background: linear-gradient(135deg, #c56a3f 0%, #b85a31 100%);
      color: white;
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .plan-actual-header h5 {
      margin: 0;
      font-size: 0.85rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .plan-actual-table {
      width: 100%;
      border-collapse: collapse;
    }

    .plan-actual-table thead th {
      background: var(--gray-50);
      padding: 0.65rem 0.75rem;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      color: var(--gray-600);
      border-bottom: 2px solid var(--gray-200);
      text-align: center;
    }

    .plan-actual-table thead th:first-child,
    .plan-actual-table thead th:nth-child(2) {
      text-align: left;
    }

    .plan-actual-table tbody td {
      padding: 0.65rem 0.75rem;
      font-size: 0.8rem;
      border-bottom: 1px solid var(--gray-100);
      vertical-align: middle;
      text-align: center;
    }

    .plan-actual-table tbody td:first-child,
    .plan-actual-table tbody td:nth-child(2) {
      text-align: left;
      font-weight: 600;
      color: var(--gray-700);
    }

    .plan-actual-table tbody tr:hover {
      background: var(--gray-50);
    }

    .plan-actual-table tbody tr:last-child td {
      border-bottom: none;
    }

    .plan-nos {
      background: rgba(99, 102, 241, 0.1);
      color: var(--primary);
      font-weight: 600;
      padding: 0.25rem 0.5rem;
      border-radius: var(--radius-sm);
      display: inline-block;
      min-width: 40px;
      font-size: 0.75rem;
    }

    .plan-amt {
      background: rgba(14, 165, 233, 0.1);
      color: var(--secondary);
      font-weight: 600;
      padding: 0.25rem 0.5rem;
      border-radius: var(--radius-sm);
      display: inline-block;
      min-width: 60px;
      font-size: 0.75rem;
    }

    .actual-nos {
      background: var(--success-light);
      color: var(--success);
      font-weight: 600;
      padding: 0.25rem 0.5rem;
      border-radius: var(--radius-sm);
      display: inline-block;
      min-width: 40px;
      font-size: 0.75rem;
    }

    .actual-amt {
      background: rgba(5, 150, 105, 0.1);
      color: #059669;
      font-weight: 600;
      padding: 0.25rem 0.5rem;
      border-radius: var(--radius-sm);
      display: inline-block;
      min-width: 60px;
      font-size: 0.75rem;
    }

    .total-row-plan {
      background: linear-gradient(135deg, rgba(197, 106, 63, 0.15) 0%, rgba(184, 90, 49, 0.15) 100%);
      font-weight: 700;
      border-top: 2px solid #c56a3f !important;
    }

    .total-row-plan td {
      color: #c56a3f;
      font-size: 0.8rem;
      padding: 0.75rem !important;
    }

    /* Plan vs Actuals Tables Grid */
    .plan-actual-tables-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      margin-bottom: 1rem;
    }

    @media (max-width: 1400px) {
      .plan-actual-tables-grid {
        grid-template-columns: 1fr;
      }
    }

    .plan-actual-card {
      margin-bottom: 0;
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(20px);
      box-shadow: 
        0 8px 32px rgba(99, 102, 241, 0.1),
        0 2px 8px rgba(0, 0, 0, 0.05),
        0 0 0 1px rgba(99, 102, 241, 0.08) inset;
      border: 1px solid rgba(255, 255, 255, 0.8);
      cursor: pointer;
      transition: var(--transition);
    }

    .plan-actual-card:hover {
      transform: translateY(-4px);
      box-shadow: 
        0 12px 48px rgba(99, 102, 241, 0.15),
        0 4px 16px rgba(0, 0, 0, 0.08),
        0 0 0 1px rgba(99, 102, 241, 0.12) inset;
    }

    .plan-actual-card.selected {
      box-shadow: 
        0 12px 48px rgba(99, 102, 241, 0.25),
        0 0 0 2px rgba(99, 102, 241, 0.6) inset;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--gray-400);
    }

    .empty-state i {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .empty-state h4 {
      color: var(--gray-600);
      margin-bottom: 0.5rem;
    }

    /* Hide sections initially */
    .data-section {
      display: none;
    }

    .data-section.visible {
      display: block;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
      .header-top {
        flex-direction: column;
        gap: 1rem;
      }
      
      .header-meta {
        flex-wrap: wrap;
        justify-content: center;
        gap: 1rem;
      }
      
      .header-main h1 {
        font-size: 1.4rem;
      }
      
      .funnel-label {
        min-width: 100px;
        font-size: 0.7rem;
      }
      
      .kpi-value {
        font-size: 1.5rem;
      }

      .upload-zone {
        padding: 1.5rem;
      }

      .upload-zone .icon-wrapper {
        width: 60px;
        height: 60px;
      }

      .details-table-container {
        overflow-x: auto;
      }

      .details-table {
        min-width: 800px;
      }
    }

    /* ===== LOGIN SCREEN ===== */
    .login-overlay {
      position: fixed;
      inset: 0;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #1e1b4b 0%, #312e81 30%, #4c1d95 60%, #6d28d9 100%);
      overflow: hidden;
    }

    /* animated ambient orbs */
    .login-overlay .orb {
      position: absolute;
      border-radius: 50%;
      filter: blur(80px);
      opacity: 0.35;
      pointer-events: none;
    }
    .login-overlay .orb-1 {
      width: 500px; height: 500px;
      background: #6366f1;
      top: -120px; left: -100px;
      animation: orbDrift 8s ease-in-out infinite alternate;
    }
    .login-overlay .orb-2 {
      width: 380px; height: 380px;
      background: #a855f7;
      bottom: -80px; right: -60px;
      animation: orbDrift 10s ease-in-out infinite alternate-reverse;
    }
    .login-overlay .orb-3 {
      width: 260px; height: 260px;
      background: #0ea5e9;
      top: 40%; left: 55%;
      animation: orbDrift 12s ease-in-out infinite alternate;
    }
    @keyframes orbDrift {
      0%   { transform: translate(0, 0) scale(1); }
      100% { transform: translate(40px, -30px) scale(1.08); }
    }

    /* grid overlay texture */
    .login-overlay::before {
      content: '';
      position: absolute;
      inset: 0;
      background-image:
        linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
      background-size: 60px 60px;
      pointer-events: none;
    }

    .login-card {
      position: relative;
      z-index: 1;
      width: 100%;
      max-width: 420px;
      margin: 0 1rem;
      background: rgba(255,255,255,0.07);
      backdrop-filter: blur(24px);
      -webkit-backdrop-filter: blur(24px);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 24px;
      box-shadow:
        0 25px 60px rgba(0,0,0,0.35),
        0 0 0 1px rgba(255,255,255,0.08) inset;
      padding: 2.8rem 2rem 2.2rem;
      animation: cardSlideUp 0.55s cubic-bezier(0.22,1,0.36,1) both;
    }
    @keyframes cardSlideUp {
      from { opacity: 0; transform: translateY(32px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .login-logo-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      margin-bottom: 0.4rem;
    }
    .login-logo-row img {
      height: 42px;
      background: rgba(255,255,255,0.92);
      padding: 5px 10px;
      border-radius: 8px;
    }

    .login-title {
      text-align: center;
      color: #fff;
      font-size: 1.55rem;
      font-weight: 700;
      letter-spacing: -0.3px;
      margin-bottom: 0.25rem;
    }
    .login-subtitle {
      text-align: center;
      color: rgba(255,255,255,0.45);
      font-size: 0.82rem;
      margin-bottom: 1.8rem;
      font-weight: 400;
    }

    .login-field {
      margin-bottom: 1rem;
    }
    .login-field label {
      display: block;
      color: rgba(255,255,255,0.6);
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      margin-bottom: 0.4rem;
    }
    .login-input-wrap {
      position: relative;
    }
    .login-input-wrap .input-icon {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: rgba(31,41,55,0.6);
      font-size: 1.05rem;
      pointer-events: none;
    }
    .login-input-wrap input {
      width: 100%;
      padding: 0.8rem 1rem 0.8rem 2.6rem;
      background: rgba(255,255,255,0.25);
      border: 2px solid rgba(255,255,255,0.4);
      border-radius: 12px;
      color: #1f2937;
      font-size: 0.92rem;
      font-family: inherit;
      font-weight: 500;
      transition: border-color 0.25s, box-shadow 0.25s, background 0.25s;
      outline: none;
    }
    .login-input-wrap input::placeholder {
      color: rgba(31,41,55,0.5);
    }
    .login-input-wrap input:focus {
      border-color: rgba(99,102,241,0.8);
      background: rgba(255,255,255,0.35);
      box-shadow: 0 0 0 3px rgba(99,102,241,0.25);
    }
    /* password toggle eye */
    .login-input-wrap .eye-toggle {
      position: absolute;
      right: 14px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: rgba(31,41,55,0.6);
      font-size: 1.05rem;
      cursor: pointer;
      padding: 4px;
      transition: color 0.2s;
    }
    .login-input-wrap .eye-toggle:hover {
      color: rgba(31,41,55,0.9);
    }
    .login-input-wrap .eye-toggle:hover {
      color: rgba(255,255,255,0.7);
    }

    /* error toast */
    .login-error {
      display: none;
      align-items: center;
      gap: 0.5rem;
      background: rgba(239,68,68,0.18);
      border: 1px solid rgba(239,68,68,0.35);
      border-radius: 10px;
      padding: 0.65rem 0.85rem;
      margin-bottom: 1rem;
      color: #fca5a5;
      font-size: 0.8rem;
      font-weight: 500;
      animation: shake 0.4s ease;
    }
    .login-error.visible { display: flex; }
    .login-error i { font-size: 1rem; color: #ef4444; flex-shrink: 0; }
    @keyframes shake {
      0%,100% { transform: translateX(0); }
      20%     { transform: translateX(-6px); }
      40%     { transform: translateX(6px); }
      60%     { transform: translateX(-4px); }
      80%     { transform: translateX(4px); }
    }

    .login-btn {
      width: 100%;
      padding: 0.82rem;
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      border: none;
      border-radius: 12px;
      color: #fff;
      font-size: 0.95rem;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      transition: transform 0.18s, box-shadow 0.18s;
      box-shadow: 0 4px 18px rgba(99,102,241,0.4);
      margin-top: 0.4rem;
    }
    .login-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 24px rgba(99,102,241,0.5);
    }
    .login-btn:active {
      transform: translateY(0);
    }
    .login-btn i { font-size: 1.1rem; }

    .login-footer-note {
      text-align: center;
      margin-top: 1.6rem;
      color: rgba(255,255,255,0.22);
      font-size: 0.72rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
    }
    .login-footer-note i { font-size: 0.78rem; }

    /* ===== TOWER VISUALIZATION ===== */
    
    .tower-viz-container {
      display: flex;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
      overflow-x: auto;
      padding: 1rem 0;
    }
    
    .tower-column {
      flex-shrink: 0;
      background: rgba(255,255,255,0.98);
      backdrop-filter: blur(20px);
      border-radius: var(--radius-lg);
      padding: 1rem;
      box-shadow: 
        0 8px 32px rgba(99, 102, 241, 0.1),
        0 2px 8px rgba(0, 0, 0, 0.05),
        0 0 0 1px rgba(99, 102, 241, 0.08) inset;
      border: 1px solid rgba(255, 255, 255, 0.8);
      transition: var(--transition);
      min-width: 280px;
    }
    
    .tower-column:hover {
      transform: translateY(-4px);
      box-shadow: 
        0 12px 48px rgba(99, 102, 241, 0.15),
        0 4px 16px rgba(0, 0, 0, 0.08),
        0 0 0 1px rgba(99, 102, 241, 0.12) inset;
    }
    
    .tower-header {
      background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
      color: white;
      padding: 0.75rem 1rem;
      border-radius: var(--radius-md);
      margin-bottom: 1rem;
      text-align: center;
      font-weight: 700;
      font-size: 1.1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .tower-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
      margin-bottom: 1rem;
      padding: 0.75rem;
      background: var(--gray-50);
      border-radius: var(--radius-md);
    }
    
    .tower-stat {
      text-align: center;
    }
    
    .tower-stat-value {
      display: block;
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--primary);
      line-height: 1;
      margin-bottom: 0.25rem;
    }
    
    .tower-stat-label {
      display: block;
      font-size: 0.7rem;
      color: var(--gray-500);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }
    
    .tower-legend {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1rem;
      padding: 0.75rem;
      background: var(--gray-50);
      border-radius: var(--radius-md);
      overflow-x: auto;
    }
    
    .tower-floors {
      display: flex;
      flex-direction: column-reverse;
      gap: 2px;
    }
    
    .tower-floor {
      display: flex;
      gap: 2px;
      align-items: center;
    }
    
    .tower-floor-label {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--gray-600);
      min-width: 35px;
      text-align: right;
      padding-right: 8px;
      font-family: 'Courier New', monospace;
    }
    
    .tower-floor-units {
      display: flex;
      gap: 2px;
      flex: 1;
    }
    
    .tower-unit {
      flex: 1;
      min-width: 52px;
      max-width: 70px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--gray-700);
      background: white;
      border: 1.5px solid var(--gray-300);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'Courier New', monospace;
      position: relative;
      overflow: hidden;
    }
    
    .tower-unit:hover {
      transform: scale(1.08);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 10;
      border-color: var(--gray-600);
    }
    
    .tower-unit.empty {
      background: repeating-linear-gradient(
        45deg,
        #f9fafb,
        #f9fafb 4px,
        #e5e7eb 4px,
        #e5e7eb 8px
      );
      border-style: dashed;
      border-color: var(--gray-200);
      color: var(--gray-400);
      cursor: default;
      pointer-events: none;
    }
    
    /* Stage colors for tower units - custom colors */
    /* stage-0 (Scope) - removed, will use default white */
    
    .tower-unit.stage-1 { 
      background: #FFC000;
      color: #000;
      border-color: #CC9900;
    }
    .tower-unit.stage-2 { 
      background: #A5A5A5;
      color: #fff;
      border-color: #7F7F7F;
    }
    .tower-unit.stage-3 { 
      background: #FFE699;
      color: #000;
      border-color: #CCBA77;
    }
    .tower-unit.stage-4 { 
      background: #FFF2CC;
      color: #000;
      border-color: #CCC2A3;
    }
    .tower-unit.stage-5 { 
      background: #E2EFDA;
      color: #000;
      border-color: #B5BFAE;
    }
    .tower-unit.stage-6 { 
      background: #A9D08E;
      color: #000;
      border-color: #87A672;
    }
    .tower-unit.stage-7 { 
      background: #70AD47;
      color: #fff;
      border-color: #5A8A39;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.7rem;
      white-space: nowrap;
    }
    
    .legend-color {
      width: 18px;
      height: 18px;
      border-radius: 3px;
      border: 1px solid rgba(0,0,0,0.15);
      flex-shrink: 0;
    }
    
    .legend-color.stage-1 { background: #FFC000; }
    .legend-color.stage-2 { background: #A5A5A5; }
    .legend-color.stage-3 { background: #FFE699; }
    .legend-color.stage-4 { background: #FFF2CC; }
    .legend-color.stage-5 { background: #E2EFDA; }
    .legend-color.stage-6 { background: #A9D08E; }
    .legend-color.stage-7 { background: #70AD47; }
    
    @media (max-width: 768px) {
      .tower-viz-container {
        flex-direction: column;
      }
      
      .tower-column {
        min-width: 100%;
      }
      
      .tower-unit {
        min-width: 45px;
        max-width: 55px;
        height: 32px;
        font-size: 0.65rem;
      }
      
      .tower-floor-label {
        min-width: 30px;
        font-size: 0.65rem;
      }
    }

    /* Compact Stage KPI Bar for Tower Tab */
    .stage-kpi-bar {
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(20px);
      border-radius: var(--radius-lg);
      padding: 1rem 1.5rem;
      box-shadow: 
        0 8px 32px rgba(99, 102, 241, 0.1),
        0 2px 8px rgba(0, 0, 0, 0.05),
        0 0 0 1px rgba(99, 102, 241, 0.08) inset;
      border: 1px solid rgba(255, 255, 255, 0.8);
      margin-bottom: 1.5rem;
      overflow-x: auto;
    }
    
    .stage-kpi-grid {
      display: flex;
      gap: 1rem;
      align-items: center;
      justify-content: space-around;
      min-width: 900px;
    }
    
    .stage-kpi-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.4rem;
      flex: 1;
      min-width: 85px;
    }
    
    .stage-kpi-color-box {
      width: 100%;
      height: 8px;
      border-radius: 4px;
      margin-bottom: 0.2rem;
    }
    
    .stage-kpi-color-box.scope { background: white; border: 2px solid var(--gray-300); }
    .stage-kpi-color-box.sold { background: #833C0C; }
    .stage-kpi-color-box.stage-1 { background: #FFC000; }
    .stage-kpi-color-box.stage-2 { background: #A5A5A5; }
    .stage-kpi-color-box.stage-3 { background: #FFE699; }
    .stage-kpi-color-box.stage-4 { background: #FFF2CC; }
    .stage-kpi-color-box.stage-5 { background: #E2EFDA; }
    .stage-kpi-color-box.stage-6 { background: #A9D08E; }
    .stage-kpi-color-box.stage-7 { background: #70AD47; }
    
    .stage-kpi-value-compact {
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--gray-900);
      line-height: 1;
    }
    
    .stage-kpi-label-compact {
      font-size: 0.65rem;
      color: var(--gray-600);
      text-align: center;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    
    /* Villa layout specific styles */
    .tower-villa-layout {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      justify-content: center;
      padding: 1rem;
    }
    
    .villa-block {
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(20px);
      border-radius: var(--radius-md);
      padding: 0.75rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      border: 1px solid var(--gray-200);
    }
    
    .villa-block-header {
      text-align: center;
      font-weight: 700;
      font-size: 0.85rem;
      color: var(--gray-700);
      margin-bottom: 0.5rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--gray-300);
    }
    
    .villa-units-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 2px;
    }
    
    .villa-unit {
      min-width: 50px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--gray-700);
      background: white;
      border: 1.5px solid var(--gray-300);
      border-radius: 3px;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'Courier New', monospace;
    }
    
    .villa-unit:hover {
      transform: scale(1.05);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      z-index: 10;
    }
    
    .villa-unit.stage-1 { background: #FFC000; color: #000; border-color: #CC9900; }
    .villa-unit.stage-2 { background: #A5A5A5; color: #fff; border-color: #7F7F7F; }
    .villa-unit.stage-3 { background: #FFE699; color: #000; border-color: #CCBA77; }
    .villa-unit.stage-4 { background: #FFF2CC; color: #000; border-color: #CCC2A3; }
    .villa-unit.stage-5 { background: #E2EFDA; color: #000; border-color: #B5BFAE; }
    .villa-unit.stage-6 { background: #A9D08E; color: #000; border-color: #87A672; }
    .villa-unit.stage-7 { background: #70AD47; color: #fff; border-color: #5A8A39; }

    /* ===== UNIT DETAIL POPUP ===== */
    .unit-detail-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    
    .unit-detail-overlay.visible {
      display: flex;
      animation: fadeIn 0.2s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .unit-detail-card {
      background: white;
      border-radius: var(--radius-lg);
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      animation: slideUp 0.3s ease;
    }
    
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .unit-detail-header {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      color: white;
      padding: 1.5rem;
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    
    .unit-detail-header-left {
      flex: 1;
    }
    
    .unit-detail-project {
      font-size: 0.85rem;
      opacity: 0.9;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
    
    .unit-detail-unit-no {
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
    }
    
    .unit-detail-customer {
      font-size: 1rem;
      opacity: 0.95;
      font-weight: 500;
    }
    
    .unit-detail-logo {
      width: 80px;
      height: auto;
      background: white;
      padding: 4px 8px;
      border-radius: 6px;
    }
    
    .unit-detail-meta {
      padding: 1rem 1.5rem;
      background: var(--gray-50);
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      gap: 1.5rem;
    }
    
    .unit-detail-meta-item {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    
    .unit-detail-meta-label {
      font-size: 0.7rem;
      color: var(--gray-500);
      text-transform: uppercase;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    
    .unit-detail-meta-value {
      font-size: 0.95rem;
      color: var(--gray-900);
      font-weight: 600;
    }
    
    .unit-detail-body {
      padding: 1.5rem;
    }
    
    .unit-detail-section-title {
      font-size: 0.85rem;
      color: var(--gray-600);
      text-transform: uppercase;
      font-weight: 700;
      letter-spacing: 0.5px;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--gray-200);
    }
    
    .unit-activity-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    .unit-activity-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1rem;
      background: var(--gray-50);
      border-radius: var(--radius-md);
      border-left: 4px solid var(--gray-300);
      transition: var(--transition);
    }
    
    .unit-activity-item:hover {
      background: var(--gray-100);
    }
    
    .unit-activity-item.completed {
      background: rgba(16, 185, 129, 0.08);
      border-left-color: var(--success);
    }
    
    .unit-activity-name {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--gray-700);
    }
    
    .unit-activity-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.8rem;
      font-weight: 600;
    }
    
    .unit-activity-status.completed {
      color: var(--success);
    }
    
    .unit-activity-status.pending {
      color: var(--gray-400);
    }
    
    .unit-detail-footer {
      padding: 1rem 1.5rem;
      background: var(--gray-50);
      border-top: 1px solid var(--gray-200);
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
    }
    
    .unit-detail-btn {
      padding: 0.65rem 1.25rem;
      border-radius: var(--radius-md);
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      border: none;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .unit-detail-btn-close {
      background: var(--gray-200);
      color: var(--gray-700);
    }
    
    .unit-detail-btn-close:hover {
      background: var(--gray-300);
    }
    
    .unit-detail-btn-download {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }
    
    .unit-detail-btn-download:hover {
      box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
      transform: translateY(-2px);
    }

    /* ===== SEARCH FUNCTIONALITY ===== */
    .search-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    @media (max-width: 768px) {
      .search-container {
        grid-template-columns: 1fr;
      }
    }
    
    .search-box {
      position: relative;
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(20px);
      border-radius: var(--radius-lg);
      padding: 1rem 1.25rem;
      box-shadow: 
        0 8px 32px rgba(99, 102, 241, 0.1),
        0 2px 8px rgba(0, 0, 0, 0.05),
        0 0 0 1px rgba(99, 102, 241, 0.08) inset;
      border: 1px solid rgba(255, 255, 255, 0.8);
      z-index: 100;
    }
    
    .search-label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--gray-600);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 0.5rem;
    }
    
    .search-input-wrapper {
      position: relative;
    }
    
    .search-input {
      width: 100%;
      padding: 0.65rem 2.5rem 0.65rem 1rem;
      border: 2px solid var(--gray-200);
      border-radius: var(--radius-md);
      font-size: 0.9rem;
      transition: var(--transition);
      background: white;
      color: var(--gray-900);
    }
    
    .search-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    
    .search-input::placeholder {
      color: var(--gray-400);
    }
    
    .search-clear-btn {
      position: absolute;
      right: 0.5rem;
      top: 50%;
      transform: translateY(-50%);
      width: 24px;
      height: 24px;
      border: none;
      background: var(--gray-200);
      color: var(--gray-600);
      border-radius: 50%;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      transition: var(--transition);
    }
    
    .search-clear-btn:hover {
      background: var(--gray-300);
      color: var(--gray-800);
    }
    
    .search-clear-btn.visible {
      display: flex;
    }
    
    .search-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 2px solid var(--primary);
      border-top: none;
      border-radius: 0 0 var(--radius-md) var(--radius-md);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      max-height: 300px;
      overflow-y: auto;
      z-index: 10000;
      display: none;
      margin-top: -2px;
    }
    
    .search-dropdown.visible {
      display: block;
    }
    
    .search-dropdown-item {
      padding: 0.75rem 1rem;
      cursor: pointer;
      transition: var(--transition);
      border-bottom: 1px solid var(--gray-100);
    }
    
    .search-dropdown-item:last-child {
      border-bottom: none;
    }
    
    .search-dropdown-item:hover {
      background: var(--gray-50);
    }
    
    .search-dropdown-item.active {
      background: rgba(99, 102, 241, 0.1);
    }
    
    .search-dropdown-item-main {
      font-weight: 600;
      color: var(--gray-900);
      margin-bottom: 0.25rem;
      font-size: 0.9rem;
    }
    
    .search-dropdown-item-meta {
      font-size: 0.75rem;
      color: var(--gray-500);
      display: flex;
      gap: 0.75rem;
    }
    
    .search-dropdown-item-meta span {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    
    .search-no-results {
      padding: 1.5rem 1rem;
      text-align: center;
      color: var(--gray-400);
      font-size: 0.85rem;
    }
    
    .search-result-highlight {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(139, 92, 246, 0.15) 100%);
      animation: highlightPulse 2s ease-in-out 3;
    }
    
    @keyframes highlightPulse {
      0%, 100% { 
        box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4);
        transform: scale(1);
      }
      50% { 
        box-shadow: 0 0 0 8px rgba(99, 102, 241, 0);
        transform: scale(1.05);
      }
    }

    /* Clickable KPI legends */
    .stage-kpi-item {
      cursor: pointer;
      transition: var(--transition);
      padding: 0.5rem;
      border-radius: var(--radius-md);
    }
    
    .stage-kpi-item:hover {
      background: rgba(99, 102, 241, 0.05);
      transform: scale(1.02);
    }
    
    .stage-kpi-item.active {
      background: rgba(99, 102, 241, 0.1);
      box-shadow: 0 0 0 2px var(--primary);
    }
    
    /* Unit highlighting when stage is selected */
    .tower-unit.stage-highlighted,
    .villa-unit.stage-highlighted {
      box-shadow: 0 0 0 3px #fbbf24, 0 0 20px rgba(251, 191, 36, 0.6) !important;
      transform: scale(1.1) !important;
      z-index: 100 !important;
      animation: stagePulse 1.5s ease-in-out infinite;
    }
    
    .tower-unit.stage-dimmed,
    .villa-unit.stage-dimmed {
      opacity: 0.2;
      filter: grayscale(80%);
    }
    
    @keyframes stagePulse {
      0%, 100% { 
        box-shadow: 0 0 0 3px #fbbf24, 0 0 20px rgba(251, 191, 36, 0.6);
      }
      50% { 
        box-shadow: 0 0 0 5px #fbbf24, 0 0 30px rgba(251, 191, 36, 0.8);
      }
    }
    
    /* Clear filter button */
    .clear-filter-btn {
      display: none;
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: var(--radius-md);
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
      transition: var(--transition);
      margin-left: auto;
    }
    
    .clear-filter-btn.visible {
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    
    .clear-filter-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
    }
    
    /* Empty state */
    .tower-empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--gray-400);
    }
    
    .tower-empty-state i {
      font-size: 4rem;
      margin-bottom: 1rem;
      display: block;
      opacity: 0.5;
    }
    
    .tower-empty-state h3 {
      font-size: 1.2rem;
      color: var(--gray-500);
      margin-bottom: 0.5rem;
    }
    
    .tower-empty-state p {
      font-size: 0.9rem;
      color: var(--gray-400);
    }

    /* 
       LOGIN & AUTHENTICATION SYSTEM
        */
    
    /* Login Overlay */
    .login-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      animation: fadeIn 0.5s;
    }
    
    .login-overlay::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
      opacity: 0.3;
      pointer-events: none;
    }
    
    /* Animated orbs */
    .login-orb {
      position: absolute;
      border-radius: 50%;
      filter: blur(60px);
      opacity: 0.4;
      animation: float 20s infinite ease-in-out;
    }
    
    .login-orb-1 {
      width: 400px;
      height: 400px;
      background: rgba(99, 102, 241, 0.3);
      top: -100px;
      left: -100px;
      animation-delay: 0s;
    }
    
    .login-orb-2 {
      width: 350px;
      height: 350px;
      background: rgba(245, 158, 11, 0.3);
      bottom: -100px;
      right: -100px;
      animation-delay: 5s;
    }
    
    .login-orb-3 {
      width: 300px;
      height: 300px;
      background: rgba(14, 165, 233, 0.3);
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      animation-delay: 10s;
    }
    
    @keyframes float {
      0%, 100% { transform: translate(0, 0) scale(1); }
      33% { transform: translate(50px, -50px) scale(1.1); }
      66% { transform: translate(-50px, 50px) scale(0.9); }
    }
    
    /* Login Card */
    .login-card {
      position: relative;
      z-index: 2;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      padding: 3rem;
      border-radius: var(--radius-xl);
      box-shadow: 0 30px 60px rgba(0,0,0,0.3);
      max-width: 420px;
      width: 90%;
      animation: slideUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .login-logo {
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .login-logo i {
      font-size: 4rem;
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .login-title {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--gray-900);
      text-align: center;
      margin-bottom: 0.5rem;
    }
    
    .login-subtitle {
      font-size: 0.9rem;
      color: var(--gray-500);
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .login-form-group {
      margin-bottom: 1.25rem;
    }
    
    .login-form-group label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 0.5rem;
    }
    
    .login-input-wrapper {
      position: relative;
    }
    
    .login-input-icon {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray-400);
      font-size: 1.1rem;
      pointer-events: none;
    }
    
    .login-input {
      width: 100%;
      padding: 0.85rem 1rem 0.85rem 3rem;
      border: 2px solid var(--gray-200);
      border-radius: var(--radius-md);
      font-size: 0.95rem;
      transition: var(--transition);
      background: white;
    }
    
    .login-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    
    .login-input::placeholder {
      color: var(--gray-400);
    }
    
    .password-toggle {
      position: absolute;
      right: 1rem;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--gray-400);
      cursor: pointer;
      font-size: 1.1rem;
      padding: 0.25rem;
      transition: var(--transition);
    }
    
    .password-toggle:hover {
      color: var(--gray-600);
    }
    
    .login-btn {
      width: 100%;
      padding: 0.9rem;
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    
    .login-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4);
    }
    
    .login-btn:active {
      transform: translateY(0);
    }
    
    .login-error {
      background: var(--danger-light);
      color: var(--danger);
      padding: 0.75rem 1rem;
      border-radius: var(--radius-md);
      margin-bottom: 1rem;
      font-size: 0.85rem;
      display: none;
      animation: shake 0.5s;
    }
    
    .login-error.show {
      display: block;
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }
    
    /* User Management Modal */
    .user-management-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s;
    }
    
    .user-management-overlay.active {
      display: flex;
    }
    
    .user-management-modal {
      background: white;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-xl);
      max-width: 700px;
      width: 90%;
      max-height: 80vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .user-management-header {
      padding: 1.5rem 2rem;
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .user-management-header h2 {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .close-modal-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }
    
    .close-modal-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .user-management-body {
      padding: 2rem;
      overflow-y: auto;
    }
    
    .create-user-section {
      background: var(--gray-50);
      padding: 1.5rem;
      border-radius: var(--radius-md);
      margin-bottom: 2rem;
    }
    
    .create-user-section h3 {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--gray-900);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
    }
    
    .form-group label {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 0.4rem;
    }
    
    .form-group input {
      padding: 0.65rem 0.85rem;
      border: 1px solid var(--gray-300);
      border-radius: var(--radius-sm);
      font-size: 0.9rem;
      transition: var(--transition);
    }
    
    .form-group input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    
    .create-user-btn {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: var(--radius-md);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
    }
    
    .create-user-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    
    .users-list-section h3 {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--gray-900);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .users-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .users-table thead {
      background: var(--gray-100);
    }
    
    .users-table th {
      padding: 0.75rem 1rem;
      text-align: left;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--gray-700);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .users-table td {
      padding: 0.85rem 1rem;
      border-bottom: 1px solid var(--gray-200);
      font-size: 0.9rem;
    }
    
    .users-table tbody tr:hover {
      background: var(--gray-50);
    }
    
    .role-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.25rem 0.65rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    
    .role-badge.viewer {
      background: var(--primary-light);
      color: var(--primary-dark);
    }
    
    .delete-user-btn {
      background: var(--danger);
      color: white;
      border: none;
      padding: 0.4rem 0.8rem;
      border-radius: var(--radius-sm);
      font-size: 0.8rem;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }
    
    .delete-user-btn:hover {
      background: #dc2626;
      transform: translateY(-1px);
    }
    
    /* Active Sessions Modal */
    .sessions-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    
    .sessions-table th {
      background: var(--gray-100);
      padding: 0.75rem 1rem;
      text-align: left;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--gray-700);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .sessions-table td {
      padding: 0.85rem 1rem;
      border-bottom: 1px solid var(--gray-200);
      font-size: 0.9rem;
    }
    
    .sessions-table tbody tr:hover {
      background: var(--gray-50);
    }
    
    .sessions-table tbody tr.current-session {
      background: rgba(99, 102, 241, 0.05);
    }
    
    .force-logout-btn {
      background: var(--danger);
      color: white;
      border: none;
      padding: 0.4rem 0.8rem;
      border-radius: var(--radius-sm);
      font-size: 0.8rem;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }
    
    .force-logout-btn:hover {
      background: #dc2626;
      transform: translateY(-1px);
    }
    
    .force-logout-btn:disabled {
      background: var(--gray-300);
      cursor: not-allowed;
      transform: none;
    }
    
    /* Session Timeout Modal */
    .timeout-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      z-index: 10001;
      display: none;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s;
    }
    
    .timeout-modal-overlay.active {
      display: flex;
    }
    
    .timeout-modal {
      background: white;
      border-radius: var(--radius-lg);
      padding: 2rem;
      max-width: 400px;
      width: 90%;
      text-align: center;
      box-shadow: var(--shadow-xl);
      animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .timeout-modal i {
      font-size: 4rem;
      color: var(--warning);
      margin-bottom: 1rem;
    }
    
    .timeout-modal h3 {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 0.5rem;
    }
    
    .timeout-modal p {
      color: var(--gray-600);
      margin-bottom: 1.5rem;
    }
    
    .timeout-countdown {
      font-size: 2rem;
      font-weight: 700;
      color: var(--danger);
      margin-bottom: 1.5rem;
    }
    
    .timeout-modal-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.75rem 2rem;
      border-radius: var(--radius-md);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .timeout-modal-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }
    
    /* Admin Dropdown in Header */
    .admin-dropdown {
      position: relative;
    }
    
    .admin-dropdown-btn {
      background: rgba(99, 102, 241, 0.1);
      border: 1px solid rgba(99, 102, 241, 0.2);
      color: var(--primary);
      padding: 0.5rem 1rem;
      border-radius: var(--radius-md);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.85rem;
      font-weight: 600;
      transition: var(--transition);
    }
    
    .admin-dropdown-btn:hover {
      background: rgba(99, 102, 241, 0.15);
    }
    
    .admin-dropdown-menu {
      position: absolute;
      top: calc(100% + 0.5rem);
      right: 0;
      background: white;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      min-width: 200px;
      padding: 0.5rem;
      display: none;
      z-index: 99999;
    }
    
    .admin-dropdown-menu.active {
      display: block;
      animation: slideDown 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .admin-dropdown-item {
      padding: 0.65rem 1rem;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 0.9rem;
      color: var(--gray-700);
    }
    
    .admin-dropdown-item:hover {
      background: var(--gray-100);
    }
    
    .admin-dropdown-item i {
      width: 20px;
      color: var(--primary);
    }

  </style>
</head>

<body>

  <!-- 
       LOGIN OVERLAY
        -->
  <div class="login-overlay" id="loginOverlay">
    <div class="login-orb login-orb-1"></div>
    <div class="login-orb login-orb-2"></div>
    <div class="login-orb login-orb-3"></div>
    
    <div class="login-card">
      <div class="login-logo">
        <i class="bi bi-shield-lock-fill"></i>
      </div>
      <h1 class="login-title">Welcome Back</h1>
      <p class="login-subtitle">Please sign in to continue</p>
      
      <div class="login-error" id="loginError">
        <i class="bi bi-exclamation-triangle-fill"></i>
        <span id="loginErrorText">Invalid credentials</span>
      </div>
      
      <form id="loginForm" onsubmit="handleLogin(event)">
        <div class="login-form-group">
          <label for="loginUsername">Username</label>
          <div class="login-input-wrapper">
            <i class="bi bi-person-fill login-input-icon"></i>
            <input 
              type="text" 
              id="loginUsername" 
              class="login-input" 
              placeholder="Enter username"
              autocomplete="username"
            >
          </div>
        </div>
        
        <div class="login-form-group">
          <label for="loginPassword">Password</label>
          <div class="login-input-wrapper">
            <i class="bi bi-lock-fill login-input-icon"></i>
            <input 
              type="password" 
              id="loginPassword" 
              class="login-input" 
              placeholder="Enter password"
              autocomplete="current-password"
            >
            <button type="button" class="password-toggle" onclick="togglePasswordVisibility()">
              <i class="bi bi-eye-fill" id="passwordToggleIcon"></i>
            </button>
          </div>
        </div>
        
        <button type="submit" class="login-btn">
          <span>Sign In</span>
          <i class="bi bi-arrow-right"></i>
        </button>
      </form>
    </div>
  </div>

  <!-- 
       USER MANAGEMENT MODAL (ADMIN ONLY)
        -->
  <div class="user-management-overlay" id="userManagementOverlay">
    <div class="user-management-modal">
      <div class="user-management-header">
        <h2><i class="bi bi-people-fill"></i> Manage Users</h2>
        <button class="close-modal-btn" onclick="closeUserManagement()">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
      
      <div class="user-management-body">
        <!-- Create New Viewer -->
        <div class="create-user-section">
          <h3><i class="bi bi-person-plus-fill"></i> Create New Viewer Account</h3>
          <form id="createUserForm" onsubmit="createViewerAccount(event)">
            <div class="form-row">
              <div class="form-group">
                <label for="newUsername">Username</label>
                <input type="text" id="newUsername" placeholder="Enter username" required>
              </div>
              <div class="form-group">
                <label for="newPassword">Password</label>
                <input type="text" id="newPassword" placeholder="Enter password" required>
              </div>
            </div>
            <button type="submit" class="create-user-btn">
              <i class="bi bi-plus-circle-fill"></i>
              Create Viewer Account
            </button>
          </form>
        </div>
        
        <!-- Existing Users List -->
        <div class="users-list-section">
          <h3><i class="bi bi-list-ul"></i> Existing Viewer Accounts</h3>
          <table class="users-table">
            <thead>
              <tr>
                <th>Username</th>
                <th>Role</th>
                <th>Created By</th>
                <th>Created At</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              <tr>
                <td colspan="5" style="text-align: center; color: var(--gray-400); padding: 2rem;">
                  No viewer accounts created yet
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- 
       ACTIVE SESSIONS MODAL (ADMIN ONLY)
        -->
  <div class="user-management-overlay" id="activeSessionsOverlay">
    <div class="user-management-modal">
      <div class="user-management-header">
        <h2><i class="bi bi-activity"></i> Active Sessions</h2>
        <button class="close-modal-btn" onclick="closeActiveSessions()">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
      
      <div class="user-management-body">
        <table class="sessions-table">
          <thead>
            <tr>
              <th>Username</th>
              <th>Role</th>
              <th>Login Time</th>
              <th>Last Activity</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="sessionsTableBody">
            <tr>
              <td colspan="5" style="text-align: center; color: var(--gray-400); padding: 2rem;">
                No active sessions
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- 
       SESSION TIMEOUT MODAL
        -->
  <div class="timeout-modal-overlay" id="timeoutModalOverlay">
    <div class="timeout-modal">
      <i class="bi bi-clock-fill"></i>
      <h3>Session Expired</h3>
      <p>Your session has expired due to inactivity</p>
      <div class="timeout-countdown" id="timeoutCountdown">5</div>
      <button class="timeout-modal-btn" onclick="handleTimeoutLogout()">OK</button>
    </div>
  </div>



<!-- ===== LOGIN SCREEN ===== -->
<div class="login-overlay" id="loginOverlay">
  <!-- ambient orbs -->
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>
  <div class="orb orb-3"></div>

  <div class="login-card">
    <!-- logo -->
    <div class="login-logo-row">
      <img src="https://www.propeve.com/images/uploads/builders/1585296933513logo(1).png"
           alt="Logo"
           onerror="this.style.display='none'">
    </div>

    <h2 class="login-title">Business Intelligence</h2>
    <p class="login-subtitle">Sign in to access the dashboard</p>

    <!-- error toast -->
    <div class="login-error" id="loginError">
      <i class="bi bi-exclamation-circle-fill"></i>
      <span id="loginErrorMsg">Invalid credentials</span>
    </div>

    <!-- username -->
    <div class="login-field">
      <label for="loginUsername">Username</label>
      <div class="login-input-wrap">
        <i class="bi bi-person-fill input-icon"></i>
        <input type="text" id="loginUsername" placeholder="Enter username" autocomplete="off" spellcheck="false">
      </div>
    </div>

    <!-- password -->
    <div class="login-field">
      <label for="loginPassword">Password</label>
      <div class="login-input-wrap">
        <i class="bi bi-lock-fill input-icon"></i>
        <input type="password" id="loginPassword" placeholder="Enter password" autocomplete="off">
        <button class="eye-toggle" id="eyeToggle" type="button" title="Show / hide password">
          <i class="bi bi-eye-fill" id="eyeIcon"></i>
        </button>
      </div>
    </div>

    <!-- sign-in button -->
    <button class="login-btn" id="loginBtn">
      <i class="bi bi-box-arrow-in-right"></i>
      Sign In
    </button>

    <div class="login-footer-note">
      <i class="bi bi-lock"></i> Secure &middot; Local access only
    </div>
  </div>
</div>


<!-- Header -->
<header class="dashboard-header">
  <div class="header-content">
    <div class="header-top">
      <div class="logo-section">
        <img src="https://www.propeve.com/images/uploads/builders/1585296933513logo(1).png" 
             alt="Company Logo" 
             onerror="this.style.display='none'">
      </div>
      <div class="header-meta">
        <span><i class="bi bi-calendar3"></i> <span id="currentDate"></span></span>
        <span><i class="bi bi-clock"></i> <span id="currentTime"></span></span>
        <span><i class="bi bi-person-circle"></i> Welcome, Admin</span>
      
      </div>
      <div style="display: flex; align-items: center; gap: 0.6rem;">
        <button onclick="refreshData()" style="background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.4); color: white; padding: 0.5rem 1rem; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s;"
                onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
          <i class="bi bi-arrow-clockwise"></i>
          Refresh Data
        </button>
        <button onclick="logoutAdmin()" style="background: rgba(239,68,68,0.25); border: 2px solid rgba(239,68,68,0.45); color: #fca5a5; padding: 0.5rem 1rem; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s; white-space: nowrap;"
                onmouseover="this.style.background='rgba(239,68,68,0.38)'" onmouseout="this.style.background='rgba(239,68,68,0.25)'">
          <i class="bi bi-box-arrow-right"></i>
          Logout
        </button>
      </div>
    </div>
    <div class="header-main">
      <h1>
        <i class="bi bi-graph-up-arrow"></i>
        Business Intelligence
      </h1>
    </div>
  </div>
</header>

<main class="main-container">

  <!-- Auto-Load Section -->
  <div class="upload-section" id="uploadSection">
    <div class="spinner"></div>
    <h2>Loading Data from Google Sheets...</h2>
    <p>Please wait while we fetch the latest data</p>
  </div>

  <!-- Tab Navigation -->
  <div class="tab-navigation" id="tabNavigation" style="display: none;">
    <button class="tab-button active" onclick="switchTab('milestone')">
      <i class="bi bi-buildings"></i>
      Project Milestone Dashboard
    </button>
    <button class="tab-button" onclick="switchTab('planactual')">
      <i class="bi bi-graph-up-arrow"></i>
      Plan Vs Actuals Dashboard
    </button>
    <button class="tab-button" onclick="switchTab('tower')">
      <i class="bi bi-building"></i>
      Graphical Representation
    </button>
  </div>

  <!-- Milestone Dashboard Tab Content -->
  <div class="tab-content active" id="milestoneTab">
  <!-- Data Sections (Hidden until data loads) -->
  <div class="data-section" id="dataSection">

    <!-- KPI Cards -->
    <section class="kpi-grid" id="kpiSection">
      <div class="kpi-card primary">
        <div class="kpi-header">
          <div class="kpi-icon"><i class="bi bi-boxes"></i></div>
          <span class="kpi-trend up"><i class="bi bi-arrow-up"></i> Active</span>
        </div>
        <div class="kpi-value" id="kpiTotal">0</div>
        <div class="kpi-label">Total Units in Scope</div>
      </div>
      <div class="kpi-card success">
        <div class="kpi-header">
          <div class="kpi-icon"><i class="bi bi-check-circle"></i></div>
          <span class="kpi-trend up" id="kpiHandoverTrend">0%</span>
        </div>
        <div class="kpi-value" id="kpiHandover">0</div>
        <div class="kpi-label">Ready for Handover</div>
      </div>
      <div class="kpi-card warning">
        <div class="kpi-header">
          <div class="kpi-icon"><i class="bi bi-hourglass-split"></i></div>
          <span class="kpi-trend down" id="kpiPendingTrend">Pending</span>
        </div>
        <div class="kpi-value" id="kpiPending">0</div>
        <div class="kpi-label">Pending Units</div>
      </div>
      <div class="kpi-card danger">
        <div class="kpi-header">
          <div class="kpi-icon"><i class="bi bi-currency-rupee"></i></div>
          <span class="kpi-trend up">Revenue</span>
        </div>
        <div class="kpi-value" id="kpiRevenue">0</div>
        <div class="kpi-label">Pending Revenue (Cr)</div>
      </div>
    </section>

    <!-- Filter Section -->
    <section class="filter-section">
      <div class="filter-toggle">
        <h6><i class="bi bi-funnel"></i> Filters & Segments</h6>
        <button class="btn-clear-filters" onclick="clearAllFilters()">
          <i class="bi bi-x-circle"></i> Clear All
        </button>
      </div>
      <div class="filter-grid">
        <div class="filter-card">
          <div class="filter-card-header"><i class="bi bi-folder"></i> Project</div>
          <div class="filter-card-body"><div id="projectSlicer" class="slicer"></div></div>
        </div>
        <div class="filter-card">
          <div class="filter-card-header"><i class="bi bi-building"></i> Tower</div>
          <div class="filter-card-body"><div id="towerSlicer" class="slicer"></div></div>
        </div>
        <div class="filter-card">
          <div class="filter-card-header"><i class="bi bi-layers"></i> Phase</div>
          <div class="filter-card-body"><div id="phaseSlicer" class="slicer"></div></div>
        </div>
        <div class="filter-card">
          <div class="filter-card-header"><i class="bi bi-grid"></i> Inventory</div>
          <div class="filter-card-body"><div id="inventorySlicer" class="slicer"></div></div>
        </div>
        <div class="filter-card">
          <div class="filter-card-header"><i class="bi bi-file-check"></i> GFC Status</div>
          <div class="filter-card-body"><div id="gfcSlicer" class="slicer"></div></div>
        </div>
        <div class="filter-card">
          <div class="filter-card-header"><i class="bi bi-patch-check"></i> OC Status</div>
          <div class="filter-card-body"><div id="ocSlicer" class="slicer"></div></div>
        </div>
      </div>
    </section>

    <!-- Content Grid -->
    <div class="content-grid">
      <!-- Funnel Card -->
      <div class="card">
        <div class="card-header-custom">
          <h5><i class="bi bi-bar-chart-steps"></i> Construction Progress Funnel</h5>
          <span class="badge bg-primary bg-opacity-10 text-primary" id="funnelCount">0 units</span>
        </div>
        <div class="card-body-custom">
          <div id="funnel" class="funnel-container"></div>
        </div>
      </div>

      <!-- Activity Summary Card -->
      <div class="card">
        <div class="card-header-custom">
          <h5><i class="bi bi-clipboard-data"></i> Activity Summary</h5>
        </div>
        <div class="card-body-custom" style="padding: 0;">
          <table class="activity-table">
            <thead>
              <tr>
                <th>Activity</th>
                <th>Scope</th>
                <th>Done</th>
                <th>Balance</th>
                <th>Revenue ( Cr)</th>
              </tr>
            </thead>
            <tbody id="activityTable"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Summary Tables Section -->
    <section class="summary-tables-section" id="summaryTablesSection">
      <div class="summary-tables-grid">
        
        <!-- Plaster Summary Table -->
        <div class="summary-table-card">
          <div class="summary-table-header plaster">
            <h6><i class="bi bi-paint-bucket"></i> Plaster Summary</h6>
            <span class="summary-table-count" id="plasterSummaryCount">0 Projects</span>
          </div>
          <div class="summary-table-body">
            <table class="summary-table">
              <thead>
                <tr>
                  <th>Project</th>
                  <th>Bal. Units</th>
                  <th>Billable</th>
                  <th>Non-Bill</th>
                  <th>Revenue ( Cr)</th>
                </tr>
              </thead>
              <tbody id="plasterSummaryBody"></tbody>
            </table>
          </div>
        </div>

        <!-- Flooring Summary Table -->
        <div class="summary-table-card">
          <div class="summary-table-header flooring">
            <h6><i class="bi bi-grid-3x3"></i> Flooring & Dado Summary</h6>
            <span class="summary-table-count" id="flooringSummaryCount">0 Projects</span>
          </div>
          <div class="summary-table-body">
            <table class="summary-table">
              <thead>
                <tr>
                  <th>Project</th>
                  <th>Bal. Units</th>
                  <th>Billable</th>
                  <th>Non-Bill</th>
                  <th>Revenue ( Cr)</th>
                </tr>
              </thead>
              <tbody id="flooringSummaryBody"></tbody>
            </table>
          </div>
        </div>

        <!-- Handover Summary Table -->
        <div class="summary-table-card">
          <div class="summary-table-header handover">
            <h6><i class="bi bi-check-circle"></i> Ready for Handover Summary</h6>
            <span class="summary-table-count" id="handoverSummaryCount">0 Projects</span>
          </div>
          <div class="summary-table-body">
            <table class="summary-table">
              <thead>
                <tr>
                  <th>Project</th>
                  <th>Bal. Units</th>
                  <th>Billable</th>
                  <th>Non-Bill</th>
                  <th>Revenue ( Cr)</th>
                </tr>
              </thead>
              <tbody id="handoverSummaryBody"></tbody>
            </table>
          </div>
        </div>

      </div>
    </section>

    <!-- Details Table Section -->
    <section class="details-section" id="detailsSection">
      <div class="card">
        <div class="card-header-custom">
          <div class="details-header" style="width: 100%;">
            <h5>
              <i class="bi bi-table"></i> 
              Unit Details - <span id="detailsActivityName" class="activity-badge"></span>
            </h5>
            <div class="details-actions">
              <button class="btn-download-excel" onclick="downloadExcel()">
                <i class="bi bi-file-earmark-excel"></i> Download Excel
              </button>
              <button class="btn-close-details" onclick="closeDetails()">
                <i class="bi bi-x-lg"></i> Close
              </button>
            </div>
          </div>
        </div>
        <div class="card-body-custom" style="padding: 0;">
          <div class="details-table-container">
            <table class="details-table">
              <thead>
                <tr>
                  <th class="sortable" onclick="sortTable(0)">Project</th>
                  <th class="sortable" onclick="sortTable(1)">Phase</th>
                  <th class="sortable" onclick="sortTable(2)">Tower</th>
                  <th class="sortable" onclick="sortTable(3)">Unit No.</th>
                  <th class="sortable" onclick="sortTable(4)">Customer Name</th>
                  <th class="sortable" onclick="sortTable(5)">Revenue ( Cr)</th>
                </tr>
              </thead>
              <tbody id="detailsTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

  </div>

  </div>
  <!-- End Milestone Tab -->

  <!-- Plan vs Actuals Dashboard Tab Content -->
  <div class="tab-content" id="planActualTab">
    
    <!-- Plan vs Actuals Content (Hidden until data loads) -->
    <div class="data-section" id="planActualDataSection">
      
      <!-- KPI Cards -->
      <section class="kpi-grid" style="grid-template-columns: repeat(2, 1fr); margin-bottom: 1rem;">
        <div class="kpi-card primary">
          <div class="kpi-header">
            <div class="kpi-icon"><i class="bi bi-calendar-check"></i></div>
            <span class="kpi-trend up">Plan</span>
          </div>
          <div class="kpi-value" id="kpiPlanRevenue">0</div>
          <div class="kpi-label">Plan Revenue (Cr)</div>
        </div>
        <div class="kpi-card success">
          <div class="kpi-header">
            <div class="kpi-icon"><i class="bi bi-check-circle"></i></div>
            <span class="kpi-trend up">Actual</span>
          </div>
          <div class="kpi-value" id="kpiActualRevenue">0</div>
          <div class="kpi-label">Actual Revenue (Cr)</div>
        </div>
      </section>

      <!-- Filter Section -->
      <section class="filter-section">
        <div class="filter-toggle">
          <h6><i class="bi bi-funnel"></i> Filters & Segments</h6>
          <button class="btn-clear-filters" onclick="clearAllFiltersPlanActual()">
            <i class="bi bi-x-circle"></i> Clear All
          </button>
        </div>
        <div class="filter-grid">
          <div class="filter-card">
            <div class="filter-card-header"><i class="bi bi-folder"></i> Project</div>
            <div class="filter-card-body"><div id="projectSlicerPA" class="slicer"></div></div>
          </div>
          <div class="filter-card">
            <div class="filter-card-header"><i class="bi bi-building"></i> Tower</div>
            <div class="filter-card-body"><div id="towerSlicerPA" class="slicer"></div></div>
          </div>
          <div class="filter-card">
            <div class="filter-card-header"><i class="bi bi-layers"></i> Phase</div>
            <div class="filter-card-body"><div id="phaseSlicerPA" class="slicer"></div></div>
          </div>
          <div class="filter-card">
            <div class="filter-card-header"><i class="bi bi-grid"></i> Inventory</div>
            <div class="filter-card-body"><div id="inventorySlicerPA" class="slicer"></div></div>
          </div>
          <div class="filter-card">
            <div class="filter-card-header"><i class="bi bi-file-check"></i> GFC Status</div>
            <div class="filter-card-body"><div id="gfcSlicerPA" class="slicer"></div></div>
          </div>
          <div class="filter-card">
            <div class="filter-card-header"><i class="bi bi-patch-check"></i> OC Status</div>
            <div class="filter-card-body"><div id="ocSlicerPA" class="slicer"></div></div>
          </div>
          <div class="filter-card">
            <div class="filter-card-header"><i class="bi bi-calendar-range"></i> Select Year</div>
            <div class="filter-card-body">
              <div class="year-dropdown-wrapper">
                <select id="yearDropdownPA" class="year-dropdown" onchange="onYearChange()">
                  <option value="">All Years</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Plan vs Actuals Tables - Side by Side -->
      <div class="plan-actual-tables-grid">
        
        <!-- Plaster Plan vs Actuals Table -->
        <div class="plan-actual-card" id="plasterCard" onclick="showPlanActualDetails('Plaster', 'PlasterRev')">
          <div class="plan-actual-header" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
            <h5><i class="bi bi-paint-bucket"></i> Plaster</h5>
            <span class="badge bg-white bg-opacity-20" id="plasterPlanCount">0</span>
          </div>
          <div style="padding: 0;">
            <table class="plan-actual-table">
              <thead>
                <tr>
                  <th>Year</th>
                  <th>Quarter</th>
                  <th>Plan (Nos.)</th>
                  <th>Plan ( Cr)</th>
                  <th>Actual (Nos.)</th>
                  <th>Actual ( Cr)</th>
                </tr>
              </thead>
              <tbody id="plasterPlanActualBody"></tbody>
            </table>
          </div>
        </div>

        <!-- Flooring Plan vs Actuals Table -->
        <div class="plan-actual-card" id="flooringCard" onclick="showPlanActualDetails('Flooring & Dado', 'FloorRev')">
          <div class="plan-actual-header" style="background: linear-gradient(135deg, #0d9488 0%, #0f766e 100%);">
            <h5><i class="bi bi-grid-3x3"></i> Flooring & Dado</h5>
            <span class="badge bg-white bg-opacity-20" id="flooringPlanCount">0</span>
          </div>
          <div style="padding: 0;">
            <table class="plan-actual-table">
              <thead>
                <tr>
                  <th>Year</th>
                  <th>Quarter</th>
                  <th>Plan (Nos.)</th>
                  <th>Plan ( Cr)</th>
                  <th>Actual (Nos.)</th>
                  <th>Actual ( Cr)</th>
                </tr>
              </thead>
              <tbody id="flooringPlanActualBody"></tbody>
            </table>
          </div>
        </div>

        <!-- Handover Plan vs Actuals Table -->
        <div class="plan-actual-card" id="handoverCard" onclick="showPlanActualDetails('Ready for Handover', 'HandRev')">
          <div class="plan-actual-header" style="background: linear-gradient(135deg, var(--success) 0%, #059669 100%);">
            <h5><i class="bi bi-check-circle"></i> Ready for Handover</h5>
            <span class="badge bg-white bg-opacity-20" id="handoverPlanCount">0</span>
          </div>
          <div style="padding: 0;">
            <table class="plan-actual-table">
              <thead>
                <tr>
                  <th>Year</th>
                  <th>Quarter</th>
                  <th>Plan (Nos.)</th>
                  <th>Plan ( Cr)</th>
                  <th>Actual (Nos.)</th>
                  <th>Actual ( Cr)</th>
                </tr>
              </thead>
              <tbody id="handoverPlanActualBody"></tbody>
            </table>
          </div>
        </div>

      </div>

      <!-- Plan Actual Unit Details Section -->
      <section class="details-section" id="planActualDetailsSection">
        <div class="card">
          <div class="card-header-custom">
            <div class="details-header" style="width: 100%;">
              <h5>
                <i class="bi bi-table"></i> 
                Unit Details - <span id="planActualActivityName" class="activity-badge"></span>
              </h5>
              <div class="details-actions">
                <button class="btn-download-excel" onclick="downloadPlanActualExcel()">
                  <i class="bi bi-file-earmark-excel"></i> Download Excel
                </button>
                <button class="btn-close-details" onclick="closePlanActualDetails()">
                  <i class="bi bi-x-lg"></i> Close
                </button>
              </div>
            </div>
          </div>
          <div class="card-body-custom" style="padding: 0;">
            <div class="details-table-container">
              <table class="details-table">
                <thead>
                  <tr>
                    <th class="sortable" onclick="sortPlanActualTable(0)">Project</th>
                    <th class="sortable" onclick="sortPlanActualTable(1)">Phase</th>
                    <th class="sortable" onclick="sortPlanActualTable(2)">Tower</th>
                    <th class="sortable" onclick="sortPlanActualTable(3)">Unit No.</th>
                    <th class="sortable" onclick="sortPlanActualTable(4)">Customer Name</th>
                    <th class="sortable" onclick="sortPlanActualTable(5)">Plan</th>
                    <th class="sortable" onclick="sortPlanActualTable(6)">Revenue ( Cr)</th>
                  </tr>
                </thead>
                <tbody id="planActualDetailsTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

    </div>

  </div>
  <!-- End Plan Actual Tab -->
  <!-- Graphical Representation (Tower Visualization) Tab Content -->
  <div class="tab-content" id="towerTab">
    
    <!-- Tower Visualization Content (Hidden until data loads) -->
    <div class="data-section" id="towerDataSection">
      
      <!-- Project Slicer -->
      <section class="filter-section">
        <div class="filter-toggle">
          <h6><i class="bi bi-folder"></i> Select Project</h6>
        </div>
        <div class="filter-grid" style="grid-template-columns: 1fr;">
          <div class="filter-card">
            <div class="filter-card-header"><i class="bi bi-folder"></i> Project</div>
            <div class="filter-card-body"><div id="projectSlicerTower" class="slicer"></div></div>
          </div>
        </div>
      </section>


      <!-- Search Section -->
      <div class="search-container">
        <!-- Unit Number Search -->
        <div class="search-box">
          <label class="search-label">
            <i class="bi bi-hash"></i>
            Search by Unit Number
          </label>
          <div class="search-input-wrapper">
            <input 
              type="text" 
              class="search-input" 
              id="unitSearchInput"
              placeholder="Type unit number..."
              autocomplete="off">
            <button class="search-clear-btn" id="unitSearchClear">
              <i class="bi bi-x"></i>
            </button>
            <div class="search-dropdown" id="unitSearchDropdown"></div>
          </div>
        </div>
        
        <!-- Customer Name Search -->
        <div class="search-box">
          <label class="search-label">
            <i class="bi bi-person"></i>
            Search by Customer Name
          </label>
          <div class="search-input-wrapper">
            <input 
              type="text" 
              class="search-input" 
              id="customerSearchInput"
              placeholder="Type customer name..."
              autocomplete="off">
            <button class="search-clear-btn" id="customerSearchClear">
              <i class="bi bi-x"></i>
            </button>
            <div class="search-dropdown" id="customerSearchDropdown"></div>
          </div>
        </div>
      </div>
      <!-- Stage KPIs -->
      <section class="stage-kpi-grid" id="stageKpiGrid">
        <!-- KPI cards will be inserted here dynamically -->
      </section>

      <!-- Tower Visualization Grid -->
      <div class="tower-viz-container" id="towerVizContainer">
        <!-- Tower columns will be inserted here dynamically -->
      </div>

    </div>

  </div>
  <!-- End Tower Tab -->


  <!-- Empty State -->
  <div class="empty-state" id="emptyState">
    <i class="bi bi-file-earmark-bar-graph"></i>
    <h4>No Data Available</h4>
    <p>Upload a CSV file to visualize your project milestones</p>
  </div>


<!-- Unit Detail Popup Modal -->
<div class="unit-detail-overlay" id="unitDetailOverlay" onclick="if(event.target===this) closeUnitDetail()">
  <div class="unit-detail-card" id="unitDetailCard">
    <div class="unit-detail-header">
      <div class="unit-detail-header-left">
        <div class="unit-detail-project" id="popupProject"></div>
        <div class="unit-detail-unit-no" id="popupUnitNo"></div>
        <div class="unit-detail-customer" id="popupCustomer"></div>
      </div>
      <img class="unit-detail-logo" 
           src="https://www.propeve.com/images/uploads/builders/1585296933513logo(1).png" 
           alt="Logo" 
           onerror="this.style.display='none'">
    </div>
    
    <div class="unit-detail-meta" id="popupMeta">
      <!-- Tower and Phase will be inserted here if not 0 -->
    </div>
    
    <div class="unit-detail-body">
      <div class="unit-detail-section-title">
        <i class="bi bi-list-check"></i> Construction Activities
      </div>
      <div class="unit-activity-list" id="popupActivityList">
        <!-- Activities will be inserted here -->
      </div>
    </div>
    
    <div class="unit-detail-footer">
      <button class="unit-detail-btn unit-detail-btn-close" onclick="closeUnitDetail()">
        <i class="bi bi-x-lg"></i> Close
      </button>
      <button class="unit-detail-btn unit-detail-btn-download" onclick="downloadUnitDetailPDF()">
        <i class="bi bi-file-pdf"></i> Download PDF
      </button>
    </div>
  </div>
</div>
</main>

<!-- Footer -->
<footer class="dashboard-footer">
  <p> 2026 Project Milestone Dashboard  Built for Construction Excellence</p>
  <p style="margin-top: 0.5rem;">
    <i class="bi bi-shield-check"></i> Data processed locally  No server uploads
  </p>
  <div class="creator-credit">
    <div class="creator-icon">YS</div>
    <span class="creator-text">Crafted with passion by</span>
    <span class="creator-name">Yeshwanth Sesetty</span>
  </div>
</footer>

<script>
  // ========================================
  // GOOGLE SHEETS CONFIGURATION
  // ========================================
  const GOOGLE_SHEETS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRRrl7XNihStokkflZZ2gfCKtnh3woP_Z-WphBEQziue2SgygVeAOESNAygsCDY6hGnc0-9tbE-m9dA/pub?output=csv';

  // ========================================
  // AUTH GATE  credentials
  // ========================================
  const AUTH_USER = 'Admin';
  const AUTH_PASS = '3458';
  let isAuthenticated = false;

  // Auto-load data ONLY after login
  window.addEventListener('DOMContentLoaded', function() {
    // keep everything hidden; login screen is visible by default
    // data loads only when handleLogin() succeeds
  });

  // Function to load data from Google Sheets
  async function loadDataFromGoogleSheets() {
    try {
      console.log('Fetching data from Google Sheets...');

      const response = await fetch(GOOGLE_SHEETS_CSV_URL);

      if (!response.ok) {
        throw new Error('Failed to fetch data from Google Sheets');
      }

      const csvText = await response.text();

      console.log('Data fetched successfully, parsing CSV...');

      // Parse CSV using PapaParse  header:false gives a 2D array (row 0 = headers)
      // which is exactly what prepare() expects
      Papa.parse(csvText, {
        header: false,
        skipEmptyLines: true,
        complete: function(results) {
          console.log('CSV parsed successfully, processing data...');
          prepare(results.data);
          console.log('Dashboard loaded successfully!');
        },
        error: function(error) {
          console.error('Error parsing CSV:', error);
          showError('Error parsing CSV data: ' + error.message);
        }
      });

    } catch (error) {
      console.error('Error loading data:', error);
      showError('Failed to load data from Google Sheets. Please check your internet connection and try again.');
    }
  }

  // Function to show error message
  function showError(message) {
    const uploadSection = document.getElementById('uploadSection');
    uploadSection.style.display = 'flex';
    uploadSection.innerHTML = `
      <i class="bi bi-exclamation-triangle upload-icon" style="color: var(--danger); font-size: 3rem; margin-bottom: 1rem;"></i>
      <h2>Error Loading Data</h2>
      <p style="color: var(--danger); margin-bottom: 1rem;">${message}</p>
      <button onclick="location.reload()" style="background: var(--primary); color: white; border: none; padding: 0.6rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.9rem;">
        <i class="bi bi-arrow-clockwise"></i>
        Retry
      </button>
    `;
  }

  // Function to manually refresh data
  function refreshData() {
    document.getElementById('uploadSection').style.display = 'flex';
    document.getElementById('uploadSection').innerHTML = `
      <div class="spinner"></div>
      <h2>Refreshing Data...</h2>
      <p>Loading latest data from Google Sheets</p>
    `;
    document.getElementById('tabNavigation').style.display = 'none';
    document.getElementById('dataSection').classList.remove('visible');
    document.getElementById('planActualDataSection').classList.remove('visible');

    // Reload data
    loadDataFromGoogleSheets();
  }

  // Update date/time
  function updateDateTime() {
    const now = new Date();
    document.getElementById('currentDate').textContent = now.toLocaleDateString('en-IN', { 
      weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' 
    });
    document.getElementById('currentTime').textContent = now.toLocaleTimeString('en-IN', { 
      hour: '2-digit', minute: '2-digit' 
    });
  }
  updateDateTime();
  setInterval(updateDateTime, 60000);

  // Data storage
  let raw = [];
  let currentFilteredData = [];
  let currentDetailsData = [];
  let currentActivityName = '';
  let currentRevenueField = '';
  let sortColumn = -1;
  let sortAscending = true;
  let projectSel = new Set(), towerSel = new Set(), phaseSel = new Set(),
      inventorySel = new Set(), gfcSel = new Set(), ocSel = new Set();
  
  // Plan vs Actuals filters
  let projectSelPA = new Set(), towerSelPA = new Set(), phaseSelPA = new Set(),
      inventorySelPA = new Set(), gfcSelPA = new Set(), ocSelPA = new Set();
  let selectedYearPA = '2026'; // Default year
  
  // Plan Actual Details
  let currentPlanActualData = [];
  let currentPlanActualActivity = '';
  let currentPlanActualRevField = '';
  let sortColumnPA = -1;
  let sortAscendingPA = true;

  const COL = {
    PROJECT: "Project",
    TOWER: "Tower",
    PHASE: "Phase",
    INVENTORY: "Inventory",
    UNIT_NO: "Unit No",
    CUSTOMER: 4, // Column E (index 4)
    OC: 28,
    SOLD: 30, // Column AE (index 30)
    GFC: 33,
    PLASTER: 36,
    FLOOR: 39,
    HVAC: 41,
    FALSE: 42,
    FENEST: 44,
    HAND: 51,
    PLASTER_REV: 5,
    FLOOR_REV: 6,
    HAND_REV: 7,
    PLASTER_PLAN: 11, // Column L (index 11)
    PLASTER_ACTUAL: 36,  // Column AK (index 36)
    FLOORING_PLAN: 14, // Column O (index 14)
    FLOORING_ACTUAL: 39, // Column AN (index 39)
    HANDOVER_PLAN: 26, // Column AA (index 26)
    HANDOVER_ACTUAL: 51  // Column AZ (index 51)
  };

  // File handling (only wire up if upload elements exist in the DOM)
  const csvFile = document.getElementById("csvFile");
  const dropZone = document.getElementById("dropZone");

  if (dropZone && csvFile) {
    dropZone.addEventListener("click", () => csvFile.click());
    csvFile.addEventListener("change", loadCSV);

    dropZone.addEventListener("dragover", (e) => {
      e.preventDefault();
      dropZone.classList.add("dragover");
    });

    dropZone.addEventListener("dragleave", () => {
      dropZone.classList.remove("dragover");
    });

    dropZone.addEventListener("drop", (e) => {
      e.preventDefault();
      dropZone.classList.remove("dragover");
      const file = e.dataTransfer.files[0];
      if (file && (file.name.endsWith('.csv') || file.name.endsWith('.xlsx') || file.name.endsWith('.xls'))) {
        processFile(file);
      } else {
        alert('Please upload a CSV or Excel file (.csv, .xlsx, .xls)');
      }
    });
  }

  function loadCSV(e) {
    processFile(e.target.files[0]);
  }

  function processFile(file) {
    if (file.name.endsWith('.csv')) {
      // Handle CSV files with PapaParse
      Papa.parse(file, {
        skipEmptyLines: true,
        complete: res => prepare(res.data),
        error: err => {
          console.error('CSV Parse error:', err);
          alert('Error parsing CSV file');
        }
      });
    } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
      // Handle Excel files with SheetJS
      const reader = new FileReader();
      reader.onload = e => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
        prepare(jsonData);
      };
      reader.onerror = () => {
        alert('Error reading Excel file');
      };
      reader.readAsArrayBuffer(file);
    } else {
      alert('Please upload a CSV or Excel file (.csv, .xlsx, .xls)');
    }
  }

  function validDate(v) {
    return v && v !== "00-01-1900";
  }

  function prepare(rows) {
    const h = rows[0];
    raw = rows.slice(1).map(r => ({
      Project: r[h.indexOf(COL.PROJECT)],
      Tower: r[h.indexOf(COL.TOWER)],
      Phase: r[h.indexOf(COL.PHASE)],
      Inventory: r[h.indexOf(COL.INVENTORY)],
      UnitNo: r[h.indexOf(COL.UNIT_NO)] || "N/A",
      Customer: r[COL.CUSTOMER] || "N/A",
      OC: r[COL.OC],
      Sold: (r[COL.SOLD] || '').toLowerCase() === 'sold',
      GFC: validDate(r[COL.GFC]),
      Plaster: validDate(r[COL.PLASTER]),
      Floor: validDate(r[COL.FLOOR]),
      HVAC: validDate(r[COL.HVAC]),
      False: validDate(r[COL.FALSE]),
      Fenest: validDate(r[COL.FENEST]),
      Hand: validDate(r[COL.HAND]),
      PlasterRev: +r[COL.PLASTER_REV] || 0,
      FloorRev: +r[COL.FLOOR_REV] || 0,
      HandRev: +r[COL.HAND_REV] || 0,
      PlasterPlan: r[COL.PLASTER_PLAN] || "",
      PlasterActual: r[COL.PLASTER_ACTUAL] || "",
      FlooringPlan: r[COL.FLOORING_PLAN] || "",
      FlooringActual: r[COL.FLOORING_ACTUAL] || "",
      HandoverPlan: r[COL.HANDOVER_PLAN] || "",
      HandoverActual: r[COL.HANDOVER_ACTUAL] || ""
    }));

    // Update UI
    const statusBadge = document.getElementById("statusBadge");
    if (statusBadge) statusBadge.classList.add("success");
    const statusText = document.getElementById("statusText");
    if (statusText) statusText.innerHTML = 
      `<i class="bi bi-check-circle-fill"></i> Loaded ${raw.length.toLocaleString()} units successfully`;

    document.getElementById("uploadSection").style.display = "none";
    const emptyState = document.getElementById("emptyState");
    if (emptyState) emptyState.style.display = "none";
    document.getElementById("tabNavigation").style.display = "flex";
    document.getElementById("dataSection").classList.add("visible");
    document.getElementById("planActualDataSection").classList.add("visible");

    buildAllSlicers();
    render();
    buildPlanActualSlicers();
    
    // Default year is already set in selectedYearPA = '2026'
    
    generatePlanVsActuals();
    
    // Build tower visualization
    buildTowerProjectSlicer();
    document.getElementById('towerDataSection').classList.add('visible');
  }

  function buildSlicer(id, vals, store) {
    const el = document.getElementById(id);
    el.innerHTML = "";
    
    const all = document.createElement("button");
    all.innerText = "All";
    all.classList.add("active");
    all.onclick = () => {
      store.clear();
      el.querySelectorAll("button").forEach(b => b.classList.remove("active"));
      all.classList.add("active");
      render();
    };
    el.appendChild(all);

    vals.sort().forEach(v => {
      if (!v) return;
      const b = document.createElement("button");
      b.innerText = v;
      b.dataset.value = v;
      b.onclick = () => {
        store.has(v) ? store.delete(v) : store.add(v);
        b.classList.toggle("active");
        all.classList.toggle("active", store.size === 0);
        render();
      };
      el.appendChild(b);
    });
  }

  function updateSlicerHighlighting() {
    // Get current filtered data
    const hasActiveFilters = projectSel.size > 0 || towerSel.size > 0 || 
                             phaseSel.size > 0 || inventorySel.size > 0 || 
                             gfcSel.size > 0 || ocSel.size > 0;
    
    if (!hasActiveFilters) {
      // Remove all highlighting if no filters
      document.querySelectorAll('.slicer button').forEach(b => {
        b.classList.remove('dimmed', 'highlighted');
      });
      return;
    }

    // Get available values based on current filters
    const d = raw.filter(r =>
      (!projectSel.size || projectSel.has(r.Project)) &&
      (!towerSel.size || towerSel.has(r.Tower)) &&
      (!phaseSel.size || phaseSel.has(r.Phase)) &&
      (!inventorySel.size || inventorySel.has(r.Inventory)) &&
      (!gfcSel.size || gfcSel.has(r.GFC ? "Yes" : "No")) &&
      (!ocSel.size || ocSel.has(r.OC))
    );

    const availableProjects = new Set(d.map(x => x.Project));
    const availableTowers = new Set(d.map(x => x.Tower));
    const availablePhases = new Set(d.map(x => x.Phase));
    const availableInventory = new Set(d.map(x => x.Inventory));
    const availableGFC = new Set(d.map(x => x.GFC ? "Yes" : "No"));
    const availableOC = new Set(d.map(x => x.OC));

    // Update each slicer
    updateSlicerButtons('projectSlicer', availableProjects, projectSel);
    updateSlicerButtons('towerSlicer', availableTowers, towerSel);
    updateSlicerButtons('phaseSlicer', availablePhases, phaseSel);
    updateSlicerButtons('inventorySlicer', availableInventory, inventorySel);
    updateSlicerButtons('gfcSlicer', availableGFC, gfcSel);
    updateSlicerButtons('ocSlicer', availableOC, ocSel);
  }

  function updateSlicerButtons(slicerId, availableValues, activeStore) {
    const slicer = document.getElementById(slicerId);
    const buttons = slicer.querySelectorAll('button:not(:first-child)');
    
    buttons.forEach(btn => {
      const value = btn.dataset.value || btn.innerText;
      
      // Skip if button is active (selected)
      if (btn.classList.contains('active')) {
        btn.classList.remove('dimmed', 'highlighted');
        return;
      }
      
      // Highlight if value is available in filtered data
      if (availableValues.has(value)) {
        btn.classList.remove('dimmed');
        btn.classList.add('highlighted');
      } else {
        btn.classList.remove('highlighted');
        btn.classList.add('dimmed');
      }
    });
  }

  function buildAllSlicers() {
    buildSlicer("projectSlicer", [...new Set(raw.map(r => r.Project))], projectSel);
    buildSlicer("towerSlicer", [...new Set(raw.map(r => r.Tower))], towerSel);
    buildSlicer("phaseSlicer", [...new Set(raw.map(r => r.Phase))], phaseSel);
    buildSlicer("inventorySlicer", [...new Set(raw.map(r => r.Inventory))], inventorySel);
    buildSlicer("gfcSlicer", ["Yes", "No"], gfcSel);
    buildSlicer("ocSlicer", ["OC recvd", "OC not recvd"], ocSel);
  }

  function buildPlanActualSlicers() {
    buildSlicerPA("projectSlicerPA", [...new Set(raw.map(r => r.Project))], projectSelPA);
    buildSlicerPA("towerSlicerPA", [...new Set(raw.map(r => r.Tower))], towerSelPA);
    buildSlicerPA("phaseSlicerPA", [...new Set(raw.map(r => r.Phase))], phaseSelPA);
    buildSlicerPA("inventorySlicerPA", [...new Set(raw.map(r => r.Inventory))], inventorySelPA);
    buildSlicerPA("gfcSlicerPA", ["Yes", "No"], gfcSelPA);
    buildSlicerPA("ocSlicerPA", ["OC recvd", "OC not recvd"], ocSelPA);
    
    // Build Year dropdown from all plan/actual dates
    const years = new Set();
    raw.forEach(r => {
      [r.PlasterPlan, r.PlasterActual, r.FlooringPlan, r.FlooringActual, r.HandoverPlan, r.HandoverActual].forEach(dateStr => {
        const date = parseDate(dateStr);
        if (date) years.add(date.getFullYear().toString());
      });
    });
    
    const yearDropdown = document.getElementById('yearDropdownPA');
    yearDropdown.innerHTML = '<option value="">All Years</option>';
    [...years].sort().forEach(year => {
      const option = document.createElement('option');
      option.value = year;
      option.textContent = year;
      if (year === '2026') option.selected = true;
      yearDropdown.appendChild(option);
    });
  }

  function onYearChange() {
    selectedYearPA = document.getElementById('yearDropdownPA').value || '';
    generatePlanVsActuals();
  }

  function buildSlicerPA(id, vals, store) {
    const el = document.getElementById(id);
    el.innerHTML = "";
    
    const all = document.createElement("button");
    all.innerText = "All";
    all.classList.add("active");
    all.onclick = () => {
      store.clear();
      el.querySelectorAll("button").forEach(b => b.classList.remove("active"));
      all.classList.add("active");
      generatePlanVsActuals();
    };
    el.appendChild(all);

    vals.sort().forEach(v => {
      if (!v) return;
      const b = document.createElement("button");
      b.innerText = v;
      b.dataset.value = v;
      b.onclick = () => {
        store.has(v) ? store.delete(v) : store.add(v);
        b.classList.toggle("active");
        all.classList.toggle("active", store.size === 0);
        generatePlanVsActuals();
      };
      el.appendChild(b);
    });
  }

  function updateSlicerHighlightingPA() {
    // Get current filtered data
    const hasActiveFilters = projectSelPA.size > 0 || towerSelPA.size > 0 || 
                             phaseSelPA.size > 0 || inventorySelPA.size > 0 || 
                             gfcSelPA.size > 0 || ocSelPA.size > 0;
    
    if (!hasActiveFilters) {
      // Remove all highlighting if no filters
      document.querySelectorAll('#planActualDataSection .slicer button').forEach(b => {
        b.classList.remove('dimmed', 'highlighted');
      });
      return;
    }

    // Get available values based on current filters
    const d = raw.filter(r =>
      (!projectSelPA.size || projectSelPA.has(r.Project)) &&
      (!towerSelPA.size || towerSelPA.has(r.Tower)) &&
      (!phaseSelPA.size || phaseSelPA.has(r.Phase)) &&
      (!inventorySelPA.size || inventorySelPA.has(r.Inventory)) &&
      (!gfcSelPA.size || gfcSelPA.has(r.GFC ? "Yes" : "No")) &&
      (!ocSelPA.size || ocSelPA.has(r.OC))
    );

    const availableProjects = new Set(d.map(x => x.Project));
    const availableTowers = new Set(d.map(x => x.Tower));
    const availablePhases = new Set(d.map(x => x.Phase));
    const availableInventory = new Set(d.map(x => x.Inventory));
    const availableGFC = new Set(d.map(x => x.GFC ? "Yes" : "No"));
    const availableOC = new Set(d.map(x => x.OC));

    // Update each slicer
    updateSlicerButtonsPA('projectSlicerPA', availableProjects, projectSelPA);
    updateSlicerButtonsPA('towerSlicerPA', availableTowers, towerSelPA);
    updateSlicerButtonsPA('phaseSlicerPA', availablePhases, phaseSelPA);
    updateSlicerButtonsPA('inventorySlicerPA', availableInventory, inventorySelPA);
    updateSlicerButtonsPA('gfcSlicerPA', availableGFC, gfcSelPA);
    updateSlicerButtonsPA('ocSlicerPA', availableOC, ocSelPA);
  }

  function updateSlicerButtonsPA(slicerId, availableValues, activeStore) {
    const slicer = document.getElementById(slicerId);
    const buttons = slicer.querySelectorAll('button:not(:first-child)');
    
    buttons.forEach(btn => {
      const value = btn.dataset.value || btn.innerText;
      
      // Skip if button is active (selected)
      if (btn.classList.contains('active')) {
        btn.classList.remove('dimmed', 'highlighted');
        return;
      }
      
      // Highlight if value is available in filtered data
      if (availableValues.has(value)) {
        btn.classList.remove('dimmed');
        btn.classList.add('highlighted');
      } else {
        btn.classList.remove('highlighted');
        btn.classList.add('dimmed');
      }
    });
  }

  function clearAllFiltersPlanActual() {
    [projectSelPA, towerSelPA, phaseSelPA, inventorySelPA, gfcSelPA, ocSelPA].forEach(s => s.clear());
    document.querySelectorAll("#planActualDataSection .slicer button").forEach(b => {
      b.classList.remove("active", "dimmed", "highlighted");
    });
    document.querySelectorAll("#planActualDataSection .slicer button:first-child").forEach(b => b.classList.add("active"));
    
    // Reset year dropdown to 2026
    selectedYearPA = '2026';
    document.getElementById('yearDropdownPA').value = '2026';
    
    generatePlanVsActuals();
  }

  function clearAllFilters() {
    [projectSel, towerSel, phaseSel, inventorySel, gfcSel, ocSel].forEach(s => s.clear());
    document.querySelectorAll(".slicer button").forEach(b => {
      b.classList.remove("active", "dimmed", "highlighted");
    });
    document.querySelectorAll(".slicer button:first-child").forEach(b => b.classList.add("active"));
    render();
  }

  function render() {
    const d = raw.filter(r =>
      (!projectSel.size || projectSel.has(r.Project)) &&
      (!towerSel.size || towerSel.has(r.Tower)) &&
      (!phaseSel.size || phaseSel.has(r.Phase)) &&
      (!inventorySel.size || inventorySel.has(r.Inventory)) &&
      (!gfcSel.size || gfcSel.has(r.GFC ? "Yes" : "No")) &&
      (!ocSel.size || ocSel.has(r.OC))
    );

    currentFilteredData = d;

    const scope = d.length;
    const handover = d.filter(x => x.Hand).length;
    const pending = scope - handover;
    
    // Calculate pending revenue as sum of Plaster, Flooring & Dado, and Handover revenues
    const plasterPendingRev = d.filter(x => !x.Plaster).reduce((s, x) => s + x.PlasterRev, 0);
    const flooringPendingRev = d.filter(x => !x.Floor).reduce((s, x) => s + x.FloorRev, 0);
    const handoverPendingRev = d.filter(x => !x.Hand).reduce((s, x) => s + x.HandRev, 0);
    const totalPendingRev = (plasterPendingRev + flooringPendingRev + handoverPendingRev) / 10000000;

    // Update KPIs
    document.getElementById("kpiTotal").textContent = scope.toLocaleString();
    document.getElementById("kpiHandover").textContent = handover.toLocaleString();
    document.getElementById("kpiHandoverTrend").textContent = scope > 0 ? Math.round((handover / scope) * 100) + '%' : '0%';
    document.getElementById("kpiPending").textContent = pending.toLocaleString();
    document.getElementById("kpiRevenue").textContent = '' + totalPendingRev.toFixed(1);
    document.getElementById("funnelCount").textContent = scope.toLocaleString() + ' units';

    // Activity table
    const rows = [
      ["GFC Released", scope, d.filter(x => x.GFC).length, null, "GFC"],
      ["Plaster", scope, d.filter(x => x.Plaster).length, d.filter(x => !x.Plaster).reduce((s, x) => s + x.PlasterRev, 0), "Plaster"],
      ["Flooring & Dado", scope, d.filter(x => x.Floor).length, d.filter(x => !x.Floor).reduce((s, x) => s + x.FloorRev, 0), "Floor"],
      ["HVAC Installed", scope, d.filter(x => x.HVAC).length, null, "HVAC"],
      ["False Ceiling", scope, d.filter(x => x.False).length, null, "False"],
      ["Fenestration", scope, d.filter(x => x.Fenest).length, null, "Fenest"],
      ["Ready for Handover", scope, d.filter(x => x.Hand).length, d.filter(x => !x.Hand).reduce((s, x) => s + x.HandRev, 0), "Hand"]
    ];

    const tb = document.getElementById("activityTable");
    tb.innerHTML = "";
    rows.forEach(r => {
      const bal = r[1] - r[2];
      const rev = r[3] != null ? (r[3] / 10000000).toFixed(2) : "";
      const pct = r[1] > 0 ? Math.round((r[2] / r[1]) * 100) : 0;
      
      // Check if activity is clickable
      const isClickable = ["Plaster", "Flooring & Dado", "Ready for Handover"].includes(r[0]);
      const activityKey = r[4];
      
      tb.innerHTML += `
        <tr class="${isClickable ? 'clickable' : ''}" ${isClickable ? `onclick="showDetails('${activityKey}', '${r[0]}')"` : ''}>
          <td>
            <span class="activity-name ${isClickable ? 'clickable' : ''}">
              ${r[0]}
              ${isClickable ? '<i class="bi bi-hand-index"></i>' : ''}
            </span>
            <div class="progress-mini">
              <div class="progress-mini-bar" style="width: ${pct}%"></div>
            </div>
          </td>
          <td class="cell-scope">${r[1]}</td>
          <td class="cell-complete">${r[2]}</td>
          <td><span class="cell-balance">${bal}</span></td>
          <td>${rev ? `<span class="cell-revenue">${rev}</span>` : '<span style="color:#ccc"></span>'}</td>
        </tr>`;
    });

    // Funnel
    const stages = [
      ["Total Scope", scope],
      ["GFC Released", rows[0][2]],
      ["Plaster", rows[1][2]],
      ["Flooring & Dado", rows[2][2]],
      ["HVAC Installed", rows[3][2]],
      ["False Ceiling", rows[4][2]],
      ["Fenestration", rows[5][2]],
      ["Ready for Handover", rows[6][2]]
    ];

    const max = scope || 1;
    const f = document.getElementById("funnel");
    f.innerHTML = "";

    stages.forEach((s, i) => {
      const w = (s[1] / max) * 100;
      f.innerHTML += `
        <div class="funnel-row">
          <div class="funnel-label">
            <span class="stage-dot dot-${i}"></span>
            ${s[0]}
          </div>
          <div class="funnel-bar-container">
            <div class="funnel-bar stage-${i}" style="width: ${Math.max(w, 5)}%">${s[1].toLocaleString()}</div>
          </div>
        </div>`;
    });

    // Generate summary tables
    generateSummaryTables();
    
    // Update slicer highlighting
    updateSlicerHighlighting();
  }

  function showDetails(activityKey, activityName) {
    const d = currentFilteredData;
    let filteredUnits = [];
    let revenueField = '';

    // Filter units based on activity
    switch(activityKey) {
      case 'Plaster':
        filteredUnits = d.filter(x => !x.Plaster);
        revenueField = 'PlasterRev';
        break;
      case 'Floor':
        filteredUnits = d.filter(x => !x.Floor);
        revenueField = 'FloorRev';
        break;
      case 'Hand':
        filteredUnits = d.filter(x => !x.Hand);
        revenueField = 'HandRev';
        break;
      default:
        filteredUnits = [];
    }

    // Store current data globally
    currentDetailsData = filteredUnits;
    currentActivityName = activityName;
    currentRevenueField = revenueField;
    
    // Set default sort to revenue column (index 5) in descending order
    sortColumn = 5;
    sortAscending = false;
    
    // Sort by revenue descending initially
    currentDetailsData.sort((a, b) => {
      const valA = a[currentRevenueField] || 0;
      const valB = b[currentRevenueField] || 0;
      return valB - valA; // Descending order
    });

    // Update details section
    document.getElementById("detailsActivityName").textContent = activityName;
    
    renderDetailsTable();

    // Show details section
    document.getElementById("detailsSection").classList.add("visible");
    
    // Smooth scroll to details section
    setTimeout(() => {
      document.getElementById("detailsSection").scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
      });
    }, 100);
  }

  function generateSummaryTables() {
    const d = currentFilteredData;
    
    // Get unique projects
    const projects = [...new Set(d.map(x => x.Project))].filter(p => p).sort();
    
    // Generate Plaster Summary
    generateActivitySummary(projects, d, 'Plaster', 'PlasterRev', 'plasterSummaryBody', 'plasterSummaryCount');
    
    // Generate Flooring Summary
    generateActivitySummary(projects, d, 'Floor', 'FloorRev', 'flooringSummaryBody', 'flooringSummaryCount');
    
    // Generate Handover Summary
    generateActivitySummary(projects, d, 'Hand', 'HandRev', 'handoverSummaryBody', 'handoverSummaryCount');
    
    // Show summary tables section
    document.getElementById("summaryTablesSection").classList.add("visible");
  }

  function generateActivitySummary(projects, data, activityField, revenueField, tbodyId, countId) {
    const tbody = document.getElementById(tbodyId);
    tbody.innerHTML = "";
    
    let totalBalance = 0;
    let totalBillable = 0;
    let totalNonBillable = 0;
    let totalRevenue = 0;
    
    projects.forEach(project => {
      // Filter units for this project
      const projectUnits = data.filter(x => x.Project === project);
      
      // Calculate balance units (units without this activity completed)
      const balanceUnits = projectUnits.filter(x => !x[activityField]);
      const balanceCount = balanceUnits.length;
      
      // Calculate billable (balance units with revenue > 0)
      const billableUnits = balanceUnits.filter(x => x[revenueField] > 0);
      const billableCount = billableUnits.length;
      
      // Calculate non-billable
      const nonBillableCount = balanceCount - billableCount;
      
      // Calculate revenue (sum of revenue for balance units)
      const revenue = balanceUnits.reduce((sum, x) => sum + (x[revenueField] || 0), 0) / 10000000;
      
      // Update totals
      totalBalance += balanceCount;
      totalBillable += billableCount;
      totalNonBillable += nonBillableCount;
      totalRevenue += revenue;
      
      // Add row
      tbody.innerHTML += `
        <tr>
          <td class="summary-project-name">${project}</td>
          <td class="summary-number">${balanceCount}</td>
          <td><span class="summary-billable">${billableCount}</span></td>
          <td><span class="summary-non-billable">${nonBillableCount}</span></td>
          <td class="summary-revenue">${revenue.toFixed(2)}</td>
        </tr>`;
    });
    
    // Add total row
    if (projects.length > 0) {
      tbody.innerHTML += `
        <tr class="summary-total-row">
          <td><strong>TOTAL</strong></td>
          <td class="summary-number"><strong>${totalBalance}</strong></td>
          <td><strong>${totalBillable}</strong></td>
          <td><strong>${totalNonBillable}</strong></td>
          <td><strong>${totalRevenue.toFixed(2)}</strong></td>
        </tr>`;
    }
    
    // Update count badge
    document.getElementById(countId).textContent = `${projects.length} Project${projects.length !== 1 ? 's' : ''}`;
  }

  function renderDetailsTable() {
    const tbody = document.getElementById("detailsTableBody");
    tbody.innerHTML = "";

    if (currentDetailsData.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="6" style="text-align: center; padding: 2rem; color: var(--gray-400);">
            <i class="bi bi-info-circle" style="font-size: 2rem; margin-bottom: 0.5rem; display: block;"></i>
            No pending units for this activity
          </td>
        </tr>`;
      return;
    }

    // Calculate total revenue
    const totalRevenue = currentDetailsData.reduce((sum, unit) => sum + (unit[currentRevenueField] || 0), 0) / 10000000;
    
    // Add total row at the top
    tbody.innerHTML = `
      <tr class="total-row">
        <td colspan="5">
          <span class="total-label">
            <i class="bi bi-calculator"></i>
            <strong>TOTAL - ${currentDetailsData.length} Units</strong>
          </span>
        </td>
        <td class="revenue-cell" style="font-size: 1.1rem;">
          <strong>${totalRevenue.toFixed(2)} Cr</strong>
        </td>
      </tr>`;
    
    // Add individual unit rows
    currentDetailsData.forEach(unit => {
      const revenue = ((unit[currentRevenueField] || 0) / 10000000).toFixed(2);
      tbody.innerHTML += `
        <tr>
          <td>${unit.Project || 'N/A'}</td>
          <td>${unit.Phase || 'N/A'}</td>
          <td>${unit.Tower || 'N/A'}</td>
          <td class="unit-number">${unit.UnitNo}</td>
          <td class="customer-name">${unit.Customer}</td>
          <td class="revenue-cell">${revenue}</td>
        </tr>`;
    });

    // Update sort indicators
    document.querySelectorAll('.details-table thead th.sortable').forEach((th, idx) => {
      th.classList.remove('asc', 'desc');
      if (idx === sortColumn) {
        th.classList.add(sortAscending ? 'asc' : 'desc');
      }
    });
  }

  function sortTable(columnIndex) {
    // Toggle sort direction if clicking the same column
    if (sortColumn === columnIndex) {
      sortAscending = !sortAscending;
    } else {
      sortColumn = columnIndex;
      sortAscending = true;
    }

    // Sort the data
    currentDetailsData.sort((a, b) => {
      let valA, valB;

      switch(columnIndex) {
        case 0: // Project
          valA = a.Project || '';
          valB = b.Project || '';
          break;
        case 1: // Phase
          valA = a.Phase || '';
          valB = b.Phase || '';
          break;
        case 2: // Tower
          valA = a.Tower || '';
          valB = b.Tower || '';
          break;
        case 3: // Unit No
          valA = a.UnitNo || '';
          valB = b.UnitNo || '';
          break;
        case 4: // Customer Name
          valA = a.Customer || '';
          valB = b.Customer || '';
          break;
        case 5: // Revenue
          valA = a[currentRevenueField] || 0;
          valB = b[currentRevenueField] || 0;
          break;
        default:
          return 0;
      }

      // Handle numeric comparison for revenue
      if (columnIndex === 5) {
        return sortAscending ? valA - valB : valB - valA;
      }

      // String comparison for other columns
      if (valA < valB) return sortAscending ? -1 : 1;
      if (valA > valB) return sortAscending ? 1 : -1;
      return 0;
    });

    renderDetailsTable();
  }

  function downloadExcel() {
    if (currentDetailsData.length === 0) {
      alert('No data to download');
      return;
    }

    // Prepare data for Excel
    const excelData = [];
    
    // Add header row
    excelData.push(['Project', 'Phase', 'Tower', 'Unit No.', 'Customer Name', 'Revenue ( Cr)']);
    
    // Add total row
    const totalRevenue = currentDetailsData.reduce((sum, unit) => sum + (unit[currentRevenueField] || 0), 0) / 10000000;
    excelData.push(['TOTAL', '', '', `${currentDetailsData.length} Units`, '', totalRevenue.toFixed(2)]);
    
    // Add data rows
    currentDetailsData.forEach(unit => {
      const revenue = ((unit[currentRevenueField] || 0) / 10000000).toFixed(2);
      excelData.push([
        unit.Project || 'N/A',
        unit.Phase || 'N/A',
        unit.Tower || 'N/A',
        unit.UnitNo,
        unit.Customer,
        revenue
      ]);
    });

    // Create workbook and worksheet
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(excelData);

    // Set column widths
    ws['!cols'] = [
      { wch: 20 },  // Project
      { wch: 15 },  // Phase
      { wch: 15 },  // Tower
      { wch: 15 },  // Unit No
      { wch: 25 },  // Customer Name
      { wch: 15 }   // Revenue
    ];

    // Add worksheet to workbook
    XLSX.utils.book_append_sheet(wb, ws, currentActivityName);

    // Generate filename with timestamp
    const timestamp = new Date().toISOString().slice(0, 10);
    const filename = `${currentActivityName.replace(/\s+/g, '_')}_${timestamp}.xlsx`;

    // Save file
    XLSX.writeFile(wb, filename);
  }

  function closeDetails() {
    document.getElementById("detailsSection").classList.remove("visible");
  }

  // Tab Switching
  function switchTab(tabName) {
    // Update tab buttons
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    event.target.closest('.tab-button').classList.add('active');
    
    // Update tab content
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    if (tabName === 'milestone') {
      document.getElementById('milestoneTab').classList.add('active');
    } else if (tabName === 'planactual') {
      document.getElementById('planActualTab').classList.add('active');
    } else if (tabName === 'tower') {
      document.getElementById('towerTab').classList.add('active');
    }
  }

  // Parse date from DD-MM-YYYY format
  function parseDate(dateStr) {
    if (!dateStr || dateStr === "00-01-1900") return null;
    const parts = dateStr.split('-');
    if (parts.length === 3) {
      return new Date(parts[2], parts[1] - 1, parts[0]);
    }
    return null;
  }

  // Get quarter from date
  function getQuarter(date) {
    if (!date) return null;
    const month = date.getMonth();
    return Math.floor(month / 3) + 1;
  }

  // Generate Plan vs Actuals Dashboard
  function generatePlanVsActuals() {
    // Apply filters
    const filteredData = raw.filter(r =>
      (!projectSelPA.size || projectSelPA.has(r.Project)) &&
      (!towerSelPA.size || towerSelPA.has(r.Tower)) &&
      (!phaseSelPA.size || phaseSelPA.has(r.Phase)) &&
      (!inventorySelPA.size || inventorySelPA.has(r.Inventory)) &&
      (!gfcSelPA.size || gfcSelPA.has(r.GFC ? "Yes" : "No")) &&
      (!ocSelPA.size || ocSelPA.has(r.OC))
    );
    
    // Generate tables for each activity
    generateActivityTable(filteredData, 'PlasterPlan', 'PlasterActual', 'PlasterRev', 'plasterPlanActualBody', 'plasterPlanCount');
    generateActivityTable(filteredData, 'FlooringPlan', 'FlooringActual', 'FloorRev', 'flooringPlanActualBody', 'flooringPlanCount');
    generateActivityTable(filteredData, 'HandoverPlan', 'HandoverActual', 'HandRev', 'handoverPlanActualBody', 'handoverPlanCount');
    
    // Update KPIs
    updatePlanActualKPIs();
    
    // Update slicer highlighting
    updateSlicerHighlightingPA();
  }

  function generateActivityTable(filteredData, planField, actualField, revenueField, tbodyId, countId) {
    const data = {};
    
    let totalPlanRevenue = 0;
    let totalActualRevenue = 0;
    
    // Process each row
    filteredData.forEach(row => {
      // Process Plan dates
      const planDate = parseDate(row[planField]);
      if (planDate) {
        const year = planDate.getFullYear().toString();
        const quarter = getQuarter(planDate);
        
        // Apply year filter
        if (!selectedYearPA || year === selectedYearPA) {
          const key = `${year}-Q${quarter}`;
          
          if (!data[key]) {
            data[key] = {
              year: year,
              quarter: quarter,
              planNos: 0,
              planAmt: 0,
              actualNos: 0,
              actualAmt: 0
            };
          }
          
          data[key].planNos++;
          data[key].planAmt += row[revenueField];
          totalPlanRevenue += row[revenueField];
        }
      }
      
      // Process Actual dates
      const actualDate = parseDate(row[actualField]);
      if (actualDate) {
        const year = actualDate.getFullYear().toString();
        const quarter = getQuarter(actualDate);
        
        // Apply year filter
        if (!selectedYearPA || year === selectedYearPA) {
          const key = `${year}-Q${quarter}`;
          
          if (!data[key]) {
            data[key] = {
              year: year,
              quarter: quarter,
              planNos: 0,
              planAmt: 0,
              actualNos: 0,
              actualAmt: 0
            };
          }
          
          data[key].actualNos++;
          data[key].actualAmt += row[revenueField];
          totalActualRevenue += row[revenueField];
        }
      }
    });
    
    // Convert to array and sort
    const dataArray = Object.values(data).sort((a, b) => {
      if (a.year !== b.year) return a.year - b.year;
      return a.quarter - b.quarter;
    });
    
    // Render table
    const tbody = document.getElementById(tbodyId);
    tbody.innerHTML = "";
    
    let totalPlanNos = 0, totalPlanAmt = 0, totalActualNos = 0, totalActualAmt = 0;
    
    dataArray.forEach(item => {
      const planAmt = (item.planAmt / 10000000).toFixed(2);
      const actualAmt = (item.actualAmt / 10000000).toFixed(2);
      
      totalPlanNos += item.planNos;
      totalPlanAmt += item.planAmt;
      totalActualNos += item.actualNos;
      totalActualAmt += item.actualAmt;
      
      tbody.innerHTML += `
        <tr>
          <td>${item.year}</td>
          <td>Q${item.quarter}</td>
          <td><span class="plan-nos">${item.planNos}</span></td>
          <td><span class="plan-amt">${planAmt}</span></td>
          <td><span class="actual-nos">${item.actualNos}</span></td>
          <td><span class="actual-amt">${actualAmt}</span></td>
        </tr>`;
    });
    
    // Add total row
    if (dataArray.length > 0) {
      tbody.innerHTML += `
        <tr class="total-row-plan">
          <td colspan="2"><strong>TOTAL</strong></td>
          <td><strong>${totalPlanNos}</strong></td>
          <td><strong>${(totalPlanAmt / 10000000).toFixed(2)}</strong></td>
          <td><strong>${totalActualNos}</strong></td>
          <td><strong>${(totalActualAmt / 10000000).toFixed(2)}</strong></td>
        </tr>`;
    }
    
    // Update count badge
    document.getElementById(countId).textContent = `${dataArray.length}`;
    
    // Return totals for KPI update
    return { totalPlanRevenue, totalActualRevenue };
  }

  // Update KPIs separately - called after all tables are generated
  function updatePlanActualKPIs() {
    const filteredData = raw.filter(r =>
      (!projectSelPA.size || projectSelPA.has(r.Project)) &&
      (!towerSelPA.size || towerSelPA.has(r.Tower)) &&
      (!phaseSelPA.size || phaseSelPA.has(r.Phase)) &&
      (!inventorySelPA.size || inventorySelPA.has(r.Inventory)) &&
      (!gfcSelPA.size || gfcSelPA.has(r.GFC ? "Yes" : "No")) &&
      (!ocSelPA.size || ocSelPA.has(r.OC))
    );
    
    let totalPlan = 0, totalActual = 0;
    
    // Calculate from all three activities
    filteredData.forEach(row => {
      // Plaster
      const plasterPlan = parseDate(row.PlasterPlan);
      if (plasterPlan && (!selectedYearPA || plasterPlan.getFullYear().toString() === selectedYearPA)) {
        totalPlan += row.PlasterRev;
      }
      const plasterActual = parseDate(row.PlasterActual);
      if (plasterActual && (!selectedYearPA || plasterActual.getFullYear().toString() === selectedYearPA)) {
        totalActual += row.PlasterRev;
      }
      
      // Flooring
      const flooringPlan = parseDate(row.FlooringPlan);
      if (flooringPlan && (!selectedYearPA || flooringPlan.getFullYear().toString() === selectedYearPA)) {
        totalPlan += row.FloorRev;
      }
      const flooringActual = parseDate(row.FlooringActual);
      if (flooringActual && (!selectedYearPA || flooringActual.getFullYear().toString() === selectedYearPA)) {
        totalActual += row.FloorRev;
      }
      
      // Handover
      const handoverPlan = parseDate(row.HandoverPlan);
      if (handoverPlan && (!selectedYearPA || handoverPlan.getFullYear().toString() === selectedYearPA)) {
        totalPlan += row.HandRev;
      }
      const handoverActual = parseDate(row.HandoverActual);
      if (handoverActual && (!selectedYearPA || handoverActual.getFullYear().toString() === selectedYearPA)) {
        totalActual += row.HandRev;
      }
    });
    
    document.getElementById('kpiPlanRevenue').textContent = '' + (totalPlan / 10000000).toFixed(1);
    document.getElementById('kpiActualRevenue').textContent = '' + (totalActual / 10000000).toFixed(1);
  }

  // Show Plan Actual Unit Details
  function showPlanActualDetails(activityName, revenueField) {
    // Remove selection from all cards
    document.querySelectorAll('.plan-actual-card').forEach(card => card.classList.remove('selected'));
    
    // Add selection to clicked card
    event.currentTarget.classList.add('selected');
    
    const filteredData = raw.filter(r =>
      (!projectSelPA.size || projectSelPA.has(r.Project)) &&
      (!towerSelPA.size || towerSelPA.has(r.Tower)) &&
      (!phaseSelPA.size || phaseSelPA.has(r.Phase)) &&
      (!inventorySelPA.size || inventorySelPA.has(r.Inventory)) &&
      (!gfcSelPA.size || gfcSelPA.has(r.GFC ? "Yes" : "No")) &&
      (!ocSelPA.size || ocSelPA.has(r.OC))
    );
    
    // Filter by year if selected
    let unitData = filteredData;
    if (selectedYearPA) {
      unitData = unitData.filter(r => {
        let planField, actualField;
        if (revenueField === 'PlasterRev') {
          planField = 'PlasterPlan';
          actualField = 'PlasterActual';
        } else if (revenueField === 'FloorRev') {
          planField = 'FlooringPlan';
          actualField = 'FlooringActual';
        } else {
          planField = 'HandoverPlan';
          actualField = 'HandoverActual';
        }
        
        const planDate = parseDate(r[planField]);
        const actualDate = parseDate(r[actualField]);
        
        return (planDate && planDate.getFullYear().toString() === selectedYearPA) ||
               (actualDate && actualDate.getFullYear().toString() === selectedYearPA);
      });
    }
    
    // Store current data
    currentPlanActualData = unitData;
    currentPlanActualActivity = activityName;
    currentPlanActualRevField = revenueField;
    
    // Sort by revenue descending by default (column index 6 now)
    sortColumnPA = 6;
    sortAscendingPA = false;
    currentPlanActualData.sort((a, b) => (b[revenueField] || 0) - (a[revenueField] || 0));
    
    // Update header
    document.getElementById("planActualActivityName").textContent = activityName;
    
    // Render table
    renderPlanActualDetailsTable();
    
    // Show section
    document.getElementById("planActualDetailsSection").classList.add("visible");
    
    // Scroll to section
    setTimeout(() => {
      document.getElementById("planActualDetailsSection").scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
      });
    }, 100);
  }

  function renderPlanActualDetailsTable() {
    const tbody = document.getElementById('planActualDetailsTableBody');
    tbody.innerHTML = "";
    
    if (currentPlanActualData.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="7" style="text-align: center; padding: 2rem; color: var(--gray-400);">
            <i class="bi bi-info-circle" style="font-size: 2rem; margin-bottom: 0.5rem; display: block;"></i>
            No units found for this activity
          </td>
        </tr>`;
      return;
    }
    
    // Calculate total revenue
    const totalRevenue = currentPlanActualData.reduce((sum, unit) => sum + (unit[currentPlanActualRevField] || 0), 0) / 10000000;
    
    // Get plan field name
    let planField;
    if (currentPlanActualRevField === 'PlasterRev') planField = 'PlasterPlan';
    else if (currentPlanActualRevField === 'FloorRev') planField = 'FlooringPlan';
    else planField = 'HandoverPlan';
    
    // Add total row at top
    tbody.innerHTML = `
      <tr class="total-row">
        <td colspan="6">
          <span class="total-label">
            <i class="bi bi-calculator"></i>
            <strong>TOTAL - ${currentPlanActualData.length} Units</strong>
          </span>
        </td>
        <td class="revenue-cell" style="font-size: 1.1rem;">
          <strong>${totalRevenue.toFixed(2)} Cr</strong>
        </td>
      </tr>`;
    
    // Add individual rows
    currentPlanActualData.forEach(unit => {
      const revenue = ((unit[currentPlanActualRevField] || 0) / 10000000).toFixed(2);
      const planDate = parseDate(unit[planField]);
      let planText = 'N/A';
      if (planDate) {
        const year = planDate.getFullYear();
        const quarter = getQuarter(planDate);
        planText = `${year} Q${quarter}`;
      }
      
      tbody.innerHTML += `
        <tr>
          <td>${unit.Project || 'N/A'}</td>
          <td>${unit.Phase || 'N/A'}</td>
          <td>${unit.Tower || 'N/A'}</td>
          <td class="unit-number">${unit.UnitNo}</td>
          <td class="customer-name">${unit.Customer}</td>
          <td>${planText}</td>
          <td class="revenue-cell">${revenue}</td>
        </tr>`;
    });
    
    // Update sort indicators
    document.querySelectorAll('#planActualDetailsSection .details-table thead th.sortable').forEach((th, idx) => {
      th.classList.remove('asc', 'desc');
      if (idx === sortColumnPA) {
        th.classList.add(sortAscendingPA ? 'asc' : 'desc');
      }
    });
  }

  function sortPlanActualTable(columnIndex) {
    if (sortColumnPA === columnIndex) {
      sortAscendingPA = !sortAscendingPA;
    } else {
      sortColumnPA = columnIndex;
      sortAscendingPA = true;
    }
    
    // Get plan field name
    let planField;
    if (currentPlanActualRevField === 'PlasterRev') planField = 'PlasterPlan';
    else if (currentPlanActualRevField === 'FloorRev') planField = 'FlooringPlan';
    else planField = 'HandoverPlan';
    
    currentPlanActualData.sort((a, b) => {
      let valA, valB;
      
      switch(columnIndex) {
        case 0: valA = a.Project || ''; valB = b.Project || ''; break;
        case 1: valA = a.Phase || ''; valB = b.Phase || ''; break;
        case 2: valA = a.Tower || ''; valB = b.Tower || ''; break;
        case 3: valA = a.UnitNo || ''; valB = b.UnitNo || ''; break;
        case 4: valA = a.Customer || ''; valB = b.Customer || ''; break;
        case 5: // Plan column
          const dateA = parseDate(a[planField]);
          const dateB = parseDate(b[planField]);
          valA = dateA ? dateA.getTime() : 0;
          valB = dateB ? dateB.getTime() : 0;
          break;
        case 6: valA = a[currentPlanActualRevField] || 0; valB = b[currentPlanActualRevField] || 0; break;
        default: return 0;
      }
      
      if (columnIndex === 5 || columnIndex === 6) {
        return sortAscendingPA ? valA - valB : valB - valA;
      }
      
      if (valA < valB) return sortAscendingPA ? -1 : 1;
      if (valA > valB) return sortAscendingPA ? 1 : -1;
      return 0;
    });
    
    renderPlanActualDetailsTable();
  }

  function closePlanActualDetails() {
    document.getElementById("planActualDetailsSection").classList.remove("visible");
    document.querySelectorAll('.plan-actual-card').forEach(card => card.classList.remove('selected'));
  }

  function downloadPlanActualExcel() {
    if (currentPlanActualData.length === 0) {
      alert('No data to download');
      return;
    }
    
    // Get plan field name
    let planField;
    if (currentPlanActualRevField === 'PlasterRev') planField = 'PlasterPlan';
    else if (currentPlanActualRevField === 'FloorRev') planField = 'FlooringPlan';
    else planField = 'HandoverPlan';
    
    const excelData = [];
    excelData.push(['Project', 'Phase', 'Tower', 'Unit No.', 'Customer Name', 'Plan', `Revenue - ${currentPlanActualActivity} ( Cr)`]);
    
    const totalRevenue = currentPlanActualData.reduce((sum, unit) => sum + (unit[currentPlanActualRevField] || 0), 0) / 10000000;
    excelData.push(['TOTAL', '', '', `${currentPlanActualData.length} Units`, '', '', totalRevenue.toFixed(2)]);
    
    currentPlanActualData.forEach(unit => {
      const revenue = ((unit[currentPlanActualRevField] || 0) / 10000000).toFixed(2);
      const planDate = parseDate(unit[planField]);
      let planText = 'N/A';
      if (planDate) {
        const year = planDate.getFullYear();
        const quarter = getQuarter(planDate);
        planText = `${year} Q${quarter}`;
      }
      
      excelData.push([
        unit.Project || 'N/A',
        unit.Phase || 'N/A',
        unit.Tower || 'N/A',
        unit.UnitNo,
        unit.Customer,
        planText,
        revenue
      ]);
    });
    
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(excelData);
    
    ws['!cols'] = [
      { wch: 20 },
      { wch: 15 },
      { wch: 15 },
      { wch: 15 },
      { wch: 25 },
      { wch: 15 },
      { wch: 20 }
    ];
    
    XLSX.utils.book_append_sheet(wb, ws, currentPlanActualActivity);
    
    const timestamp = new Date().toISOString().slice(0, 10);
    const filename = `${currentPlanActualActivity.replace(/\s+/g, '_')}_Plan_Actual_${timestamp}.xlsx`;
    
    XLSX.writeFile(wb, filename);
  }

  // ===== LOGIN / LOGOUT LOGIC =====
  (function() {
    const overlay  = document.getElementById('loginOverlay');
    const userEl   = document.getElementById('loginUsername');
    const passEl   = document.getElementById('loginPassword');
    const errBox   = document.getElementById('loginError');
    const errMsg   = document.getElementById('loginErrorMsg');
    const btn      = document.getElementById('loginBtn');
    const eyeBtn   = document.getElementById('eyeToggle');
    const eyeIcon  = document.getElementById('eyeIcon');

    // allow Enter key
    userEl.addEventListener('keydown', function(e) { if (e.key === 'Enter') btn.click(); });
    passEl.addEventListener('keydown', function(e) { if (e.key === 'Enter') btn.click(); });

    // clear error on any input change
    userEl.addEventListener('input', hideError);
    passEl.addEventListener('input', hideError);

    // password visibility toggle
    eyeBtn.addEventListener('click', function() {
      if (passEl.type === 'password') {
        passEl.type = 'text';
        eyeIcon.classList.replace('bi-eye-fill','bi-eye-slash-fill');
      } else {
        passEl.type = 'password';
        eyeIcon.classList.replace('bi-eye-slash-fill','bi-eye-fill');
      }
      passEl.focus();
    });

    btn.addEventListener('click', handleLogin);

    function handleLogin() {
      const u = userEl.value.trim();
      const p = passEl.value;

      if (!u && !p) {
        showErr('Please enter your username and password.');
        userEl.focus();
        return;
      }
      if (!u) {
        showErr('Username is required.');
        userEl.focus();
        return;
      }
      if (!p) {
        showErr('Password is required.');
        passEl.focus();
        return;
      }

      if (u === AUTH_USER && p === AUTH_PASS) {
        // success  hide login, show dashboard, kick off data load
        isAuthenticated = true;
        overlay.style.opacity = '0';
        overlay.style.transition = 'opacity 0.4s ease';
        setTimeout(function() { overlay.style.display = 'none'; }, 400);
        loadDataFromGoogleSheets();
      } else {
        // wrong creds
        if (u !== AUTH_USER) {
          showErr('Invalid username or password.');
          userEl.value = '';
          passEl.value = '';
          userEl.focus();
        } else {
          showErr('Invalid username or password.');
          passEl.value = '';
          passEl.focus();
        }
      }
    }

    function showErr(msg) {
      errMsg.textContent = msg;
      errBox.classList.remove('visible');
      // force re-trigger animation
      void errBox.offsetWidth;
      errBox.classList.add('visible');
    }

    function hideError() {
      errBox.classList.remove('visible');
    }
  })();

  // Logout: show login screen again, reset everything
  function logoutAdmin() {
    isAuthenticated = false;
    const overlay = document.getElementById('loginOverlay');
    overlay.style.display = 'flex';
    overlay.style.opacity = '0';
    void overlay.offsetWidth;
    overlay.style.transition = 'opacity 0.35s ease';
    overlay.style.opacity = '1';

    // clear inputs
    document.getElementById('loginUsername').value = '';
    document.getElementById('loginPassword').value = '';
    document.getElementById('loginPassword').type = 'password';
    document.getElementById('eyeIcon').classList.replace('bi-eye-slash-fill','bi-eye-fill');
    document.getElementById('loginError').classList.remove('visible');

    // reset dashboard state so it reloads fresh on next login
    document.getElementById('uploadSection').style.display = 'flex';
    document.getElementById('uploadSection').innerHTML = '<div class="spinner"></div><h2>Loading Data from Google Sheets...</h2><p>Please wait while we fetch the latest data</p>';
    document.getElementById('tabNavigation').style.display = 'none';
    document.getElementById('dataSection').classList.remove('visible');
    document.getElementById('planActualDataSection').classList.remove('visible');

    // focus username on next tick so it's ready
    setTimeout(function() { document.getElementById('loginUsername').focus(); }, 450);
  }

  // ===== TOWER VISUALIZATION MODULE =====
  
  let selectedProjectTower = null; // Default to none (empty state)
  
  // Build tower project slicer
  function buildTowerProjectSlicer() {
    const projects = [...new Set(raw.map(r => r.Project))].filter(Boolean).sort();
    const el = document.getElementById('projectSlicerTower');
    el.innerHTML = '';
    
    projects.forEach(proj => {
      const btn = document.createElement('button');
      btn.textContent = proj;
      btn.dataset.value = proj;
      
      btn.onclick = function() {
        // Single-select behavior for tower viz
        el.querySelectorAll('button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        selectedProjectTower = proj;
        renderTowerVisualization();
      };
      
      el.appendChild(btn);
    });
    
    // Show empty state by default and initialize cross-project search
    showEmptyState();
  }
  
  function showEmptyState() {
    const container = document.getElementById('towerVizContainer');
    const kpiGrid = document.getElementById('stageKpiGrid');
    
    container.innerHTML = `
      <div class="tower-empty-state">
        <i class="bi bi-building"></i>
        <h3>Select a Project</h3>
        <p>Please select a project from the options above to view the graphical representation</p>
      </div>
    `;
    
    if (kpiGrid) {
      kpiGrid.innerHTML = '';
      const parentBar = kpiGrid.parentElement;
      if (parentBar && parentBar.classList.contains('stage-kpi-bar')) {
        parentBar.style.display = 'none';
      }
    }
    
    // Initialize search for all projects when in empty state
    initializeSearch();
  }
  
  // Parse unit number: XXXX -> tower, floor, flat
  function parseUnitNumber(unitNo) {
    if (!unitNo) return null;
    
    // Handle units with alphabetic suffixes (e.g., 1011a, 1011b)
    const unitStr = unitNo.toString();
    const numericPart = unitStr.replace(/[a-zA-Z]/g, '');
    const suffix = unitStr.replace(/[0-9]/g, '').toLowerCase();
    
    const str = numericPart.padStart(4, '0');
    return {
      tower: parseInt(str[0], 10) || 0,
      floor: parseInt(str.substring(1, 3), 10) || 0,
      flat: parseInt(str[3], 10) || 0,
      suffix: suffix || '',
      original: unitNo,
      numericValue: parseInt(numericPart, 10)
    };
  }
  
  // Determine completion stage for a unit (1-7, skip 0 for Scope)
  function getUnitStage(unit) {
    // Stages: 1:GFC, 2:Plaster, 3:Floor, 4:HVAC, 5:False, 6:Fenest, 7:Hand
    // Return highest completed stage (-1 if none)
    let stage = -1;
    if (unit.GFC) stage = 1;
    if (unit.Plaster) stage = 2;
    if (unit.Floor) stage = 3;
    if (unit.HVAC) stage = 4;
    if (unit.False) stage = 5;
    if (unit.Fenest) stage = 6;
    if (unit.Hand) stage = 7;
    return stage;
  }
  
  function renderTowerVisualization() {
    // Show empty state if no project selected
    if (!selectedProjectTower) {
      showEmptyState();
      return;
    }
    
    const projectData = raw.filter(r => r.Project === selectedProjectTower);
    
    if (projectData.length === 0) {
      document.getElementById('towerVizContainer').innerHTML = `
        <div style="text-align: center; padding: 3rem; color: var(--gray-400); width: 100%;">
          <i class="bi bi-building" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>
          <p>No units found for project "${selectedProjectTower}"</p>
        </div>`;
      document.getElementById('stageKpiGrid').innerHTML = '';
      return;
    }
    
    // Show KPI bar
    const kpiGrid = document.getElementById('stageKpiGrid');
    const parentBar = kpiGrid.parentElement;
    if (parentBar && parentBar.classList.contains('stage-kpi-bar')) {
      parentBar.style.display = 'block';
    }
    
    // Render Stage KPIs
    renderStageKPIs(projectData);
    
    // Initialize search
    initializeSearch();
    
    // Parse all units and organize by tower/floor/flat
    const parsed = projectData.map(u => ({
      ...u,
      parsed: parseUnitNumber(u.UnitNo),
      stage: getUnitStage(u)
    })).filter(u => u.parsed !== null);
    
    // Group by tower
    const towerMap = {};
    parsed.forEach(u => {
      const t = u.parsed.tower;
      if (!towerMap[t]) towerMap[t] = [];
      towerMap[t].push(u);
    });
    
    // Sort tower numbers
    const towerNumbers = Object.keys(towerMap).map(Number).sort((a, b) => a - b);
    
    // Render each tower
    const container = document.getElementById('towerVizContainer');
    container.innerHTML = '';
    
    // Check if villa project  render villa (tower=0) units, then still render any tower units
    if (isVillaProject(selectedProjectTower)) {
      const villaUnits  = parsed.filter(u => u.parsed.tower === 0);
      const towerOnlyUnits = parsed.filter(u => u.parsed.tower !== 0);

      // Render villa blocks first
      if (villaUnits.length > 0) {
        renderVillaLayout(container, villaUnits, selectedProjectTower);
      }

      // Then render remaining towers (non-zero tower number)
      if (towerOnlyUnits.length > 0) {
        const towerOnlyMap = {};
        towerOnlyUnits.forEach(u => {
          const t = u.parsed.tower;
          if (!towerOnlyMap[t]) towerOnlyMap[t] = [];
          towerOnlyMap[t].push(u);
        });
        const towerNums = Object.keys(towerOnlyMap).map(Number).sort((a, b) => a - b);
        towerNums.forEach(tNum => renderSingleTower(container, tNum, towerOnlyMap[tNum]));
      }
      return;
    }
    
    towerNumbers.forEach(towerNum => {
      renderSingleTower(container, towerNum, towerMap[towerNum]);
    });
  }

  function renderSingleTower(container, towerNum, towerUnits) {
      // Get floor range for this tower
      const floors = [...new Set(towerUnits.map(u => u.parsed.floor))].sort((a, b) => a - b);
      const minFloor = Math.min(...floors);
      const maxFloor = Math.max(...floors);
      
      // Get max flats per floor
      const flatsPerFloor = {};
      towerUnits.forEach(u => {
        const f = u.parsed.floor;
        const flat = u.parsed.flat;
        if (!flatsPerFloor[f]) flatsPerFloor[f] = 0;
        flatsPerFloor[f] = Math.max(flatsPerFloor[f], flat);
      });
      const maxFlats = Math.max(...Object.values(flatsPerFloor));
      
      // Build tower HTML
      const headerTitle = towerNum === 0 ? 'Villas' : `Tower - ${towerNum}`;
      
      let towerHTML = `
        <div class="tower-column">
          <div class="tower-header">${headerTitle}</div>
          <div class="tower-stats">
            <div class="tower-stat">
              <span class="tower-stat-value">${towerUnits.length}</span>
              <span class="tower-stat-label">Units</span>
            </div>
          </div>
          <div class="tower-floors">`;
      
      // Create a map for quick unit lookup, grouping units by floor-flat (handling a/b suffixes)
      const unitMap = {};
      towerUnits.forEach(u => {
        const key = `${u.parsed.floor}-${u.parsed.flat}`;
        if (!unitMap[key]) unitMap[key] = [];
        unitMap[key].push(u);
      });
      
      // Sort units with same floor-flat by suffix (no suffix first, then 'a', then 'b')
      Object.keys(unitMap).forEach(key => {
        unitMap[key].sort((a, b) => {
          if (!a.parsed.suffix && !b.parsed.suffix) return 0;
          if (!a.parsed.suffix) return -1;
          if (!b.parsed.suffix) return 1;
          return a.parsed.suffix.localeCompare(b.parsed.suffix);
        });
      });
      
      // Render floors from bottom to top
      for (let floor = minFloor; floor <= maxFloor; floor++) {
        const floorFlats = flatsPerFloor[floor] || maxFlats;
        
        towerHTML += `
          <div class="tower-floor">
            <div class="tower-floor-label">F${floor.toString().padStart(2, '0')}</div>
            <div class="tower-floor-units">`;
        
        for (let flat = 1; flat <= floorFlats; flat++) {
          const key = `${floor}-${flat}`;
          const units = unitMap[key] || [];
          
          if (units.length > 0) {
            units.forEach(unit => {
              const stageClass = unit.stage >= 0 ? `stage-${unit.stage}` : '';
              const unitNoDisplay = unit.UnitNo || `${towerNum}${floor.toString().padStart(2, '0')}${flat}${unit.parsed.suffix}`;
              const unitJson = JSON.stringify(unit).replace(/'/g, "&apos;");
              towerHTML += `
                <div class="tower-unit ${stageClass}" 
                     data-unit="${unitNoDisplay}"
                     onclick='showUnitDetail(${unitJson})'
                     title="${unitNoDisplay}&#10;Customer: ${unit.Customer || 'N/A'}&#10;Stage: ${getStageName(unit.stage)}">
                  ${unitNoDisplay}
                </div>`;
            });
          } else {
            towerHTML += `<div class="tower-unit empty"></div>`;
          }
        }
        
        towerHTML += `
            </div>
          </div>`;
      }
      
      towerHTML += `
          </div>
        </div>`;
      
      container.innerHTML += towerHTML;
  }
  
  function getStageName(stage) {
    const names = {
      1: 'GFC Released',
      2: 'Plaster',
      3: 'Flooring & Dado',
      4: 'HVAC Installed',
      5: 'False Ceiling',
      6: 'Fenestration',
      7: 'Ready for Handover'
    };
    return names[stage] || 'Incomplete';
  }
  
  function renderStageKPIs(data) {
    const stages = [
      { id: 'scope', name: 'Scope', count: data.length },
      { id: 'sold', name: 'Sold', count: data.filter(u => u.Sold).length },
      { id: 'stage-1', name: 'GFC Released', count: data.filter(u => u.GFC).length },
      { id: 'stage-2', name: 'Plaster', count: data.filter(u => u.Plaster).length },
      { id: 'stage-3', name: 'Flooring & Dado', count: data.filter(u => u.Floor).length },
      { id: 'stage-4', name: 'HVAC Installed', count: data.filter(u => u.HVAC).length },
      { id: 'stage-5', name: 'False Ceiling', count: data.filter(u => u.False).length },
      { id: 'stage-6', name: 'Fenestration', count: data.filter(u => u.Fenest).length },
      { id: 'stage-7', name: 'Ready for Handover', count: data.filter(u => u.Hand).length }
    ];
    
    const container = document.getElementById('stageKpiGrid');
    const parentBar = container.parentElement;
    
    if (!parentBar.classList.contains('stage-kpi-bar')) {
      const bar = document.createElement('div');
      bar.className = 'stage-kpi-bar';
      const parent = container.parentElement;
      parent.insertBefore(bar, container);
      bar.appendChild(container);
    }
    
    container.innerHTML = stages.map(s => `
      <div class="stage-kpi-item" data-stage="${s.id}" onclick="filterByStage('${s.id}')">
        <div class="stage-kpi-color-box ${s.id}"></div>
        <div class="stage-kpi-value-compact">${s.count.toLocaleString()}</div>
        <div class="stage-kpi-label-compact">${s.name}</div>
      </div>
    `).join('');
    
    // Add clear filter button if not exists
    if (!parentBar.querySelector('.clear-filter-btn')) {
      const clearBtn = document.createElement('button');
      clearBtn.className = 'clear-filter-btn';
      clearBtn.innerHTML = '<i class="bi bi-x-circle"></i> Clear Filter';
      clearBtn.onclick = clearStageFilter;
      parentBar.appendChild(clearBtn);
    }
  }
  
  // Check if project is a villa project (TMD, AtR, or POARR)
  function isVillaProject(projectName) {
    if (!projectName) return false;
    const name = projectName.toUpperCase().trim();
    return name.includes('TMD') || name.includes('ATR') || name.includes('POARR');
  }

  // Render villa layout for TMD, AtR, and POARR projects
  function renderVillaLayout(container, units, projectName) {
    const name = projectName.toUpperCase().trim();
    if (name.includes('TMD')) {
      renderTMDLayout(container, units);
    } else if (name.includes('ATR')) {
      renderAtRLayout(container, units);
    } else if (name.includes('POARR')) {
      renderPOARRLayout(container, units);
    }
  }
  
  function renderTMDLayout(container, units) {
    // TMD Layout: Blocks 1-10 with varying configurations
    const blocks = [
      { name: 'Block-1', units: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16] },
      { name: 'Block-2', units: [17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32] },
      { name: 'Block-3', units: [33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48] },
      { name: 'Block-4', units: [49,50,51,52,53,54,55,56] },
      { name: 'Block-5', units: [57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72] },
      { name: 'Block-6', units: [73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88] },
      { name: 'Block-7', units: [89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104] },
      { name: 'Block-8', units: [105,106,107,108,109,110,111,112] },
      { name: 'Block-9', units: [113,114,115,116] },
      { name: 'Block-10', units: [117,118,119,120] }
    ];
    
    renderBlockLayout(container, units, blocks);
  }
  
  function renderAtRLayout(container, units) {
    // AtR Layout: Automatically include all units from data
    // Group units into blocks based on unit number ranges
    const blocks = [
      { name: '1EW', units: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40] },
      { name: '2EW', units: [41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80] },
      { name: '3EW', units: [81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120] },
      { name: '4EW', units: [121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160] },
      { name: '5EW', units: [161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200] },
      { name: '6EW', units: [201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240] },
      { name: '7EW', units: [241,242,243,244,245,246,247,248,249,250,251,252,253,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,272,273,274,275,276,277,278,279,280] },
      { name: '8EW', units: [281,282,283,284,285,286,287,288,289,290,291,292,293,294,295,296,297,298,299,300] }
    ];
    
    // Filter blocks to only show units that exist in the data
    const unitNumbers = new Set(units.map(u => parseInt(u.UnitNo, 10)));
    const filteredBlocks = blocks.map(block => ({
      name: block.name,
      units: block.units.filter(unitNo => unitNumbers.has(unitNo))
    })).filter(block => block.units.length > 0);
    
    renderBlockLayout(container, units, filteredBlocks);
  }
  

  function renderPOARRLayout(container, units) {
    // POARR Layout: 12 blocks as per new screenshot
    // Top row: 49,48 | 47,46 | 45,44 | 43,42 | 41,40 | 39,38 | 37,36 | 35,34 | 33,32 | 31,30 | 29,28 | 27,26
    // Bottom row: 1,2 | 3,4 | 5,6 | 7,8 | 9,10 | 11,12 | 14,15 | 16,17 | 18,19 | 20,21 | 22,23 | 24,25
    const blocks = [
      { name: 'Block-1', units: [49,48,1,2] },
      { name: 'Block-2', units: [47,46,3,4] },
      { name: 'Block-3', units: [45,44,5,6] },
      { name: 'Block-4', units: [43,42,7,8] },
      { name: 'Block-5', units: [41,40,9,10] },
      { name: 'Block-6', units: [39,38,11,12] },
      { name: 'Block-7', units: [37,36,14,15] },
      { name: 'Block-8', units: [35,34,16,17] },
      { name: 'Block-9', units: [33,32,18,19] },
      { name: 'Block-10', units: [31,30,20,21] },
      { name: 'Block-11', units: [29,28,22,23] },
      { name: 'Block-12', units: [27,26,24,25] }
    ];
    
    // Filter blocks to only show units that exist in the data
    const unitNumbers = new Set(units.map(u => parseInt(u.UnitNo, 10)));
    const filteredBlocks = blocks.map(block => ({
      name: block.name,
      units: block.units.filter(unitNo => unitNumbers.has(unitNo))
    })).filter(block => block.units.length > 0);
    
    renderBlockLayout(container, units, filteredBlocks);
  }

  function renderBlockLayout(container, units, blocks) {
    container.classList.add('tower-villa-layout');
    container.innerHTML = '';
    
    // Build unit map - handle both raw units and parsed units (with .parsed property)
    const unitMap = {};
    units.forEach(u => {
      const rawUnit = u.UnitNo !== undefined ? u : (u.original || u);
      const unitNo = parseInt(rawUnit.UnitNo, 10);
      if (!isNaN(unitNo)) unitMap[unitNo] = rawUnit;
    });
    
    blocks.forEach(block => {
      if (block.units.length === 0) return;
      
      let blockHTML = `
        <div class="villa-block">
          <div class="villa-block-header">${block.name}</div>
          <div class="villa-units-grid">`;
      
      block.units.forEach(unitNo => {
        const unit = unitMap[unitNo];
        if (unit) {
          const stageClass = unit.stage >= 0 ? `stage-${unit.stage}` : '';
          const unitJson = JSON.stringify(unit).replace(/'/g, "&apos;");
          blockHTML += `
            <div class="villa-unit ${stageClass}" 
                 data-unit="${unit.UnitNo}"
                 onclick='showUnitDetail(${unitJson})'
                 title="${unit.UnitNo}&#10;Customer: ${unit.Customer || 'N/A'}&#10;Stage: ${getStageName(unit.stage)}">
              ${unit.UnitNo}
            </div>`;
        }
      });
      
      blockHTML += `
          </div>
        </div>`;
      
      container.innerHTML += blockHTML;
    });
  }

  // ===== UNIT DETAIL POPUP =====
  let currentUnitData = null;
  
  function showUnitDetail(unit) {
    currentUnitData = unit;
    
    // Populate popup
    document.getElementById('popupProject').textContent = selectedProjectTower;
    document.getElementById('popupUnitNo').textContent = 'Unit ' + unit.UnitNo;
    document.getElementById('popupCustomer').textContent = unit.Customer || 'N/A';
    
    // Meta (Tower and Phase) - only show if not 0
    const metaHTML = [];
    const parsed = parseUnitNumber(unit.UnitNo);
    
    if (parsed && parsed.tower !== 0) {
      metaHTML.push(`
        <div class="unit-detail-meta-item">
          <span class="unit-detail-meta-label">Tower</span>
          <span class="unit-detail-meta-value">${parsed.tower}</span>
        </div>
      `);
    }
    
    if (unit.Phase && unit.Phase !== '0') {
      metaHTML.push(`
        <div class="unit-detail-meta-item">
          <span class="unit-detail-meta-label">Phase</span>
          <span class="unit-detail-meta-value">${unit.Phase}</span>
        </div>
      `);
    }
    
    document.getElementById('popupMeta').innerHTML = metaHTML.join('');
    document.getElementById('popupMeta').style.display = metaHTML.length > 0 ? 'flex' : 'none';
    
    // Activities
    const activities = [
      { name: 'GFC Released', completed: !!unit.GFC },
      { name: 'Plaster', completed: !!unit.Plaster },
      { name: 'Flooring & Dado', completed: !!unit.Floor },
      { name: 'HVAC Installed', completed: !!unit.HVAC },
      { name: 'False Ceiling', completed: !!unit.False },
      { name: 'Fenestration', completed: !!unit.Fenest },
      { name: 'Ready for Handover', completed: !!unit.Hand }
    ];
    
    const activityHTML = activities.map(a => `
      <div class="unit-activity-item ${a.completed ? 'completed' : ''}">
        <span class="unit-activity-name">${a.name}</span>
        <span class="unit-activity-status ${a.completed ? 'completed' : 'pending'}">
          <i class="bi bi-${a.completed ? 'check-circle-fill' : 'circle'}"></i>
          ${a.completed ? 'Completed' : 'Pending'}
        </span>
      </div>
    `).join('');
    
    document.getElementById('popupActivityList').innerHTML = activityHTML;
    
    // Show overlay
    document.getElementById('unitDetailOverlay').classList.add('visible');
  }
  
  function closeUnitDetail() {
    document.getElementById('unitDetailOverlay').classList.remove('visible');
    currentUnitData = null;
  }
  
  function downloadUnitDetailPDF() {
    if (!currentUnitData) return;
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Header
    doc.setFontSize(10);
    doc.setTextColor(100);
    doc.text(selectedProjectTower, 15, 20);
    
    // Try to add logo (may fail due to CORS)
    try {
      const logoUrl = 'https://www.propeve.com/images/uploads/builders/1585296933513logo(1).png';
      // Note: This will likely fail due to CORS, but we try anyway
      doc.text('TotalEnvironment', 160, 20);
    } catch(e) {
      doc.setFontSize(8);
      doc.text('TotalEnvironment', 160, 20);
    }
    
    // Unit Number
    doc.setFontSize(22);
    doc.setTextColor(0);
    doc.text('Unit ' + currentUnitData.UnitNo, 15, 35);
    
    // Customer Name
    doc.setFontSize(12);
    doc.setTextColor(60);
    doc.text(currentUnitData.Customer || 'N/A', 15, 45);
    
    // Tower & Phase
    let yPos = 55;
    const parsed = parseUnitNumber(currentUnitData.UnitNo);
    if (parsed && parsed.tower !== 0) {
      doc.setFontSize(10);
      doc.setTextColor(100);
      doc.text('Tower:', 15, yPos);
      doc.setTextColor(0);
      doc.text(String(parsed.tower), 35, yPos);
      yPos += 7;
    }
    
    if (currentUnitData.Phase && currentUnitData.Phase !== '0') {
      doc.setFontSize(10);
      doc.setTextColor(100);
      doc.text('Phase:', 15, yPos);
      doc.setTextColor(0);
      doc.text(currentUnitData.Phase, 35, yPos);
      yPos += 7;
    }
    
    // Construction Activities
    yPos += 10;
    doc.setFontSize(14);
    doc.setTextColor(0);
    doc.text('Construction Activities', 15, yPos);
    
    yPos += 10;
    doc.setLineWidth(0.5);
    doc.line(15, yPos, 195, yPos);
    yPos += 8;
    
    const activities = [
      { name: 'GFC Released', completed: !!currentUnitData.GFC },
      { name: 'Plaster', completed: !!currentUnitData.Plaster },
      { name: 'Flooring & Dado', completed: !!currentUnitData.Floor },
      { name: 'HVAC Installed', completed: !!currentUnitData.HVAC },
      { name: 'False Ceiling', completed: !!currentUnitData.False },
      { name: 'Fenestration', completed: !!currentUnitData.Fenest },
      { name: 'Ready for Handover', completed: !!currentUnitData.Hand }
    ];
    
    doc.setFontSize(10);
    activities.forEach(a => {
      doc.setTextColor(a.completed ? 0 : 150);
      doc.text(' ' + a.name, 20, yPos);
      if (a.completed) {
        doc.setTextColor(34, 197, 94);
      } else {
        doc.setTextColor(150);
      }
      doc.text(a.completed ? 'Completed' : 'Pending', 120, yPos);
      yPos += 7;
    });
    
    // Footer
    doc.setFontSize(8);
    doc.setTextColor(150);
    doc.text('Generated on ' + new Date().toLocaleString(), 15, 285);
    
    // Save
    doc.save(`Unit_${currentUnitData.UnitNo}_${selectedProjectTower}.pdf`);
  }

  // ===== SEARCH FUNCTIONALITY =====
  
  let searchData = [];
  let currentSearchSelection = -1;
  
  function initializeSearch() {
    // Clone inputs to remove stale event listeners before re-attaching
    ['unitSearchInput','customerSearchInput'].forEach(id => {
      const el = document.getElementById(id);
      if (el) { const clone = el.cloneNode(true); el.parentNode.replaceChild(clone, el); }
    });
    
    const unitInput    = document.getElementById('unitSearchInput');
    const customerInput = document.getElementById('customerSearchInput');
    const unitClear    = document.getElementById('unitSearchClear');
    const customerClear = document.getElementById('customerSearchClear');
    const unitDropdown    = document.getElementById('unitSearchDropdown');
    const customerDropdown = document.getElementById('customerSearchDropdown');
    
    // Prepare search data - all projects if none selected, otherwise current project
    const projectData = selectedProjectTower 
      ? raw.filter(r => r.Project === selectedProjectTower)
      : raw;
    searchData = projectData.map(u => ({
      unitNo: u.UnitNo,
      customer: u.Customer || 'N/A',
      project: u.Project,
      phase: u.Phase,
      tower: parseUnitNumber(u.UnitNo)?.tower || 0,
      data: u
    }));
    
    // Unit Number Search
    unitInput.addEventListener('input', function(e) {
      const query = e.target.value.trim();
      unitClear.classList.toggle('visible', query.length > 0);
      
      if (query.length === 0) {
        unitDropdown.classList.remove('visible');
        return;
      }
      
      const results = searchData.filter(item => 
        item.unitNo.toString().toLowerCase().includes(query.toLowerCase())
      ).sort((a, b) => {
        // Villa units (tower === 0) first, then tower units
        const aIsVilla = a.tower === 0 ? 0 : 1;
        const bIsVilla = b.tower === 0 ? 0 : 1;
        if (aIsVilla !== bIsVilla) return aIsVilla - bIsVilla;
        // Within same group, sort numerically by unit number
        return parseInt(a.unitNo) - parseInt(b.unitNo);
      }).slice(0, 10);
      
      displaySearchResults(results, unitDropdown, 'unit');
    });
    
    // Customer Name Search
    customerInput.addEventListener('input', function(e) {
      const query = e.target.value.trim();
      customerClear.classList.toggle('visible', query.length > 0);
      
      if (query.length === 0) {
        customerDropdown.classList.remove('visible');
        return;
      }
      
      const results = searchData.filter(item => 
        item.customer.toLowerCase().includes(query.toLowerCase())
      ).slice(0, 10);
      
      displaySearchResults(results, customerDropdown, 'customer');
    });
    
    // Clear buttons
    unitClear.addEventListener('click', function() {
      unitInput.value = '';
      unitClear.classList.remove('visible');
      unitDropdown.classList.remove('visible');
      clearSearchHighlight();
    });
    
    customerClear.addEventListener('click', function() {
      customerInput.value = '';
      customerClear.classList.remove('visible');
      customerDropdown.classList.remove('visible');
      clearSearchHighlight();
    });
    
    // Keyboard navigation
    unitInput.addEventListener('keydown', (e) => handleSearchKeydown(e, unitDropdown));
    customerInput.addEventListener('keydown', (e) => handleSearchKeydown(e, customerDropdown));
    
    // Click outside to close
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.search-box')) {
        unitDropdown.classList.remove('visible');
        customerDropdown.classList.remove('visible');
      }
    });
  }
  
  function displaySearchResults(results, dropdown, type) {
    if (results.length === 0) {
      dropdown.innerHTML = '<div class="search-no-results"><i class="bi bi-search"></i><br>No results found</div>';
      dropdown.classList.add('visible');
      return;
    }
    
    const html = results.map((item, index) => {
      let mainText, secondaryText;
      
      if (type === 'unit') {
        // Unit search: show Unit Number as main, Customer Name as secondary
        mainText = `Unit ${item.unitNo}`;
        secondaryText = `<span><i class="bi bi-person"></i> ${item.customer}</span>`;
      } else {
        // Customer search: show Customer Name as main, Unit Number as secondary
        mainText = item.customer;
        secondaryText = `<span><i class="bi bi-hash"></i> Unit ${item.unitNo}</span>`;
      }
      
      const towerText = item.tower !== 0 ? `Tower ${item.tower}` : 'Villas';
      const phaseText = item.phase && item.phase !== '0' ? `Phase ${item.phase}` : '';
      
      return `
        <div class="search-dropdown-item" data-index="${index}" onclick='selectSearchResult(${JSON.stringify(item.data).replace(/'/g, "&apos;")})'>
          <div class="search-dropdown-item-main">${mainText}</div>
          <div class="search-dropdown-item-meta">
            ${secondaryText}
            <span><i class="bi bi-building"></i> ${item.project}</span>
            <span><i class="bi bi-geo-alt"></i> ${towerText}</span>
            ${phaseText ? `<span><i class="bi bi-diagram-3"></i> ${phaseText}</span>` : ''}
          </div>
        </div>
      `;
    }).join('');
    
    dropdown.innerHTML = html;
    dropdown.classList.add('visible');
    currentSearchSelection = -1;
  }
  
  function handleSearchKeydown(e, dropdown) {
    const items = dropdown.querySelectorAll('.search-dropdown-item');
    
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      currentSearchSelection = Math.min(currentSearchSelection + 1, items.length - 1);
      updateSearchSelection(items);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      currentSearchSelection = Math.max(currentSearchSelection - 1, -1);
      updateSearchSelection(items);
    } else if (e.key === 'Enter' && currentSearchSelection >= 0) {
      e.preventDefault();
      items[currentSearchSelection].click();
    } else if (e.key === 'Escape') {
      dropdown.classList.remove('visible');
      currentSearchSelection = -1;
    }
  }
  
  function updateSearchSelection(items) {
    items.forEach((item, index) => {
      if (index === currentSearchSelection) {
        item.classList.add('active');
        item.scrollIntoView({ block: 'nearest' });
      } else {
        item.classList.remove('active');
      }
    });
  }
  
  function selectSearchResult(unit) {
    // Hide dropdowns
    document.getElementById('unitSearchDropdown').classList.remove('visible');
    document.getElementById('customerSearchDropdown').classList.remove('visible');
    
    // If unit is from a different project, switch to that project first
    if (unit.Project && unit.Project !== selectedProjectTower) {
      selectedProjectTower = unit.Project;
      // Update slicer buttons
      const slicerBtns = document.querySelectorAll('#projectSlicerTower button');
      slicerBtns.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.value === selectedProjectTower);
      });
      // Render the visualization for that project
      renderTowerVisualization();
    }
    
    // Clear previous highlights
    clearSearchHighlight();
    
    // After rendering, find and highlight the unit
    setTimeout(() => {
      const unitElements = document.querySelectorAll(`[data-unit="${unit.UnitNo}"]`);
      
      if (unitElements.length > 0) {
        const element = unitElements[0];
        element.classList.add('search-result-highlight');
        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
        setTimeout(() => element.classList.remove('search-result-highlight'), 6000);
      }
      
      // Enrich unit with stage before showing detail popup
      const enriched = Object.assign({}, unit, { stage: getUnitStage(unit) });
      showUnitDetail(enriched);
    }, 300);
  }
  
  function clearSearchHighlight() {
    document.querySelectorAll('.search-result-highlight').forEach(el => {
      el.classList.remove('search-result-highlight');
    });
  }

  // ===== STAGE FILTERING =====
  
  let selectedStageFilter = null;
  
  function filterByStage(stageId) {
    const kpiItems = document.querySelectorAll('.stage-kpi-item');
    const clearBtn = document.querySelector('.clear-filter-btn');
    
    // Toggle selection
    if (selectedStageFilter === stageId) {
      // Deselect
      selectedStageFilter = null;
      kpiItems.forEach(item => item.classList.remove('active'));
      clearBtn.classList.remove('visible');
      clearStageFilter();
      return;
    }
    
    // Select new stage
    selectedStageFilter = stageId;
    kpiItems.forEach(item => {
      if (item.dataset.stage === stageId) {
        item.classList.add('active');
      } else {
        item.classList.remove('active');
      }
    });
    
    clearBtn.classList.add('visible');
    
    // Highlight units
    highlightUnitsByStage(stageId);
  }
  
  function highlightUnitsByStage(stageId) {
    const allUnits = document.querySelectorAll('.tower-unit, .villa-unit');
    
    allUnits.forEach(unit => {
      unit.classList.remove('stage-highlighted', 'stage-dimmed');
      
      // Check if unit matches the selected stage
      const unitMatches = unit.classList.contains(stageId);
      
      if (unitMatches) {
        unit.classList.add('stage-highlighted');
      } else if (!unit.classList.contains('empty')) {
        unit.classList.add('stage-dimmed');
      }
    });
  }
  
  function clearStageFilter() {
    selectedStageFilter = null;
    const allUnits = document.querySelectorAll('.tower-unit, .villa-unit');
    const kpiItems = document.querySelectorAll('.stage-kpi-item');
    const clearBtn = document.querySelector('.clear-filter-btn');
    
    allUnits.forEach(unit => {
      unit.classList.remove('stage-highlighted', 'stage-dimmed');
    });
    
    kpiItems.forEach(item => item.classList.remove('active'));
    if (clearBtn) clearBtn.classList.remove('visible');
  }


  // 
  // AUTHENTICATION & SESSION MANAGEMENT SYSTEM
  // 
  
  // Default admin credentials (easily changeable)
  const DEFAULT_ADMIN = {
    username: 'Admin',
    password: '3458',
    role: 'admin'
  };
  
  // Session timeout: 30 minutes (in milliseconds)
  const SESSION_TIMEOUT = 30 * 60 * 1000;
  
  // Session state
  let currentSession = null;
  let inactivityTimer = null;
  let timeoutCountdown = null;
  
  // Initialize authentication on page load
  window.addEventListener('DOMContentLoaded', function() {
    // Check if there's an active session
    const session = getSession();
    if (session) {
      // Verify session is still valid
      if (isSessionValid(session)) {
        currentSession = session;
        onLoginSuccess(session);
        startInactivityTimer();
      } else {
        // Session expired, clear it
        clearSession();
        showLogin();
      }
    } else {
      showLogin();
    }
    
    // Set up activity tracking
    setupActivityTracking();
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.admin-dropdown')) {
        const menu = document.getElementById('adminDropdownMenu');
        if (menu) menu.classList.remove('active');
      }
    });
  });
  
  // 
  // SESSION MANAGEMENT
  // 
  
  function getSession() {
    try {
      const sessionStr = localStorage.getItem('currentSession');
      return sessionStr ? JSON.parse(sessionStr) : null;
    } catch (e) {
      return null;
    }
  }
  
  function saveSession(session) {
    localStorage.setItem('currentSession', JSON.stringify(session));
    
    // Also add to active sessions list
    let activeSessions = getActiveSessions();
    const existingIndex = activeSessions.findIndex(s => s.sessionId === session.sessionId);
    if (existingIndex >= 0) {
      activeSessions[existingIndex] = session;
    } else {
      activeSessions.push(session);
    }
    localStorage.setItem('activeSessions', JSON.stringify(activeSessions));
  }
  
  function clearSession() {
    const session = getSession();
    if (session) {
      // Remove from active sessions
      let activeSessions = getActiveSessions();
      activeSessions = activeSessions.filter(s => s.sessionId !== session.sessionId);
      localStorage.setItem('activeSessions', JSON.stringify(activeSessions));
    }
    localStorage.removeItem('currentSession');
    currentSession = null;
  }
  
  function getActiveSessions() {
    try {
      const sessionsStr = localStorage.getItem('activeSessions');
      return sessionsStr ? JSON.parse(sessionsStr) : [];
    } catch (e) {
      return [];
    }
  }
  
  function isSessionValid(session) {
    if (!session || !session.lastActivity) return false;
    const now = Date.now();
    const elapsed = now - session.lastActivity;
    return elapsed < SESSION_TIMEOUT;
  }
  
  function generateSessionId() {
    return 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  }
  
  function updateSessionActivity() {
    if (!currentSession) return;
    currentSession.lastActivity = Date.now();
    saveSession(currentSession);
  }
  
  // 
  // LOGIN & LOGOUT
  // 
  
  function handleLogin(event) {
    event.preventDefault();
    
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;
    const errorEl = document.getElementById('loginError');
    const errorText = document.getElementById('loginErrorText');
    
    // Validate empty fields
    if (!username) {
      errorText.textContent = 'Username is required';
      errorEl.classList.add('show');
      document.getElementById('loginUsername').focus();
      return;
    }
    
    if (!password) {
      errorText.textContent = 'Password is required';
      errorEl.classList.add('show');
      document.getElementById('loginPassword').focus();
      return;
    }
    
    // Check credentials
    let user = null;
    
    // Check admin
    if (username === DEFAULT_ADMIN.username && password === DEFAULT_ADMIN.password) {
      user = DEFAULT_ADMIN;
    } else {
      // Check viewer accounts
      const userAccounts = getUserAccounts();
      const foundUser = userAccounts.find(u => u.username === username && u.password === password);
      if (foundUser) {
        user = foundUser;
      }
    }
    
    if (!user) {
      errorText.textContent = 'Invalid username or password';
      errorEl.classList.add('show');
      // Clear password field
      document.getElementById('loginPassword').value = '';
      document.getElementById('loginPassword').focus();
      return;
    }
    
    // Create session
    const session = {
      sessionId: generateSessionId(),
      username: user.username,
      role: user.role,
      loginTime: Date.now(),
      lastActivity: Date.now()
    };
    
    currentSession = session;
    saveSession(session);
    
    // Success
    onLoginSuccess(session);
  }
  
  function onLoginSuccess(session) {
    // Hide login overlay
    const loginOverlay = document.getElementById('loginOverlay');
    loginOverlay.style.animation = 'fadeOut 0.5s';
    setTimeout(() => {
      loginOverlay.style.display = 'none';
    }, 500);
    
    // Update header
    document.getElementById('welcomeText').textContent = `Welcome, ${session.username}`;
    
    // Show admin dropdown ONLY if admin role, hide for viewers
    const adminDropdown = document.getElementById('adminDropdown');
    if (session.role === 'admin') {
      adminDropdown.style.display = 'block';
    } else {
      adminDropdown.style.display = 'none';
    }
    
    // Load data
    loadDataFromGoogleSheets();
    
    // Start inactivity timer
    startInactivityTimer();
  }
  
  function handleLogout() {
    if (!confirm('Are you sure you want to logout?')) return;
    
    performLogout();
  }
  
  function performLogout() {
    // Stop timers
    if (inactivityTimer) clearTimeout(inactivityTimer);
    if (timeoutCountdown) clearInterval(timeoutCountdown);
    
    // Clear session
    clearSession();
    
    // Reset UI
    showLogin();
  }
  
  function showLogin() {
    const loginOverlay = document.getElementById('loginOverlay');
    loginOverlay.style.display = 'flex';
    loginOverlay.style.animation = 'fadeIn 0.5s';
    
    // Clear form
    document.getElementById('loginForm').reset();
    document.getElementById('loginError').classList.remove('show');
    
    // Hide admin dropdown
    document.getElementById('adminDropdown').style.display = 'none';
    
    // Reset welcome text
    document.getElementById('welcomeText').textContent = 'Welcome, User';
    
    // Focus username
    setTimeout(() => {
      document.getElementById('loginUsername').focus();
    }, 600);
  }
  
  function togglePasswordVisibility() {
    const passwordInput = document.getElementById('loginPassword');
    const icon = document.getElementById('passwordToggleIcon');
    
    if (passwordInput.type === 'password') {
      passwordInput.type = 'text';
      icon.classList.remove('bi-eye-fill');
      icon.classList.add('bi-eye-slash-fill');
    } else {
      passwordInput.type = 'password';
      icon.classList.remove('bi-eye-slash-fill');
      icon.classList.add('bi-eye-fill');
    }
  }
  
  // 
  // INACTIVITY TIMER & AUTO TIMEOUT
  // 
  
  function setupActivityTracking() {
    const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
    
    events.forEach(event => {
      document.addEventListener(event, function() {
        if (currentSession) {
          updateSessionActivity();
          resetInactivityTimer();
        }
      }, true);
    });
  }
  
  function startInactivityTimer() {
    resetInactivityTimer();
  }
  
  function resetInactivityTimer() {
    if (inactivityTimer) {
      clearTimeout(inactivityTimer);
    }
    
    inactivityTimer = setTimeout(function() {
      showTimeoutModal();
    }, SESSION_TIMEOUT);
  }
  
  function showTimeoutModal() {
    const overlay = document.getElementById('timeoutModalOverlay');
    overlay.classList.add('active');
    
    let countdown = 5;
    document.getElementById('timeoutCountdown').textContent = countdown;
    
    timeoutCountdown = setInterval(function() {
      countdown--;
      document.getElementById('timeoutCountdown').textContent = countdown;
      
      if (countdown <= 0) {
        clearInterval(timeoutCountdown);
        handleTimeoutLogout();
      }
    }, 1000);
  }
  
  function handleTimeoutLogout() {
    const overlay = document.getElementById('timeoutModalOverlay');
    overlay.classList.remove('active');
    
    if (timeoutCountdown) {
      clearInterval(timeoutCountdown);
    }
    
    performLogout();
  }
  
  // 
  // USER MANAGEMENT (ADMIN ONLY)
  // 
  
  function getUserAccounts() {
    try {
      const accountsStr = localStorage.getItem('userAccounts');
      return accountsStr ? JSON.parse(accountsStr) : [];
    } catch (e) {
      return [];
    }
  }
  
  function saveUserAccounts(accounts) {
    localStorage.setItem('userAccounts', JSON.stringify(accounts));
  }
  
  function toggleAdminDropdown() {
    const menu = document.getElementById('adminDropdownMenu');
    menu.classList.toggle('active');
  }
  
  function openUserManagement() {
    // Close admin dropdown
    document.getElementById('adminDropdownMenu').classList.remove('active');
    
    // Show modal
    document.getElementById('userManagementOverlay').classList.add('active');
    
    // Refresh users list
    refreshUsersList();
    
    // Clear form
    document.getElementById('createUserForm').reset();
  }
  
  function closeUserManagement() {
    document.getElementById('userManagementOverlay').classList.remove('active');
  }
  
  function createViewerAccount(event) {
    event.preventDefault();
    
    const username = document.getElementById('newUsername').value.trim();
    const password = document.getElementById('newPassword').value.trim();
    
    // Validate
    if (!username || !password) {
      alert('Please enter both username and password');
      return;
    }
    
    if (password.length < 4) {
      alert('Password must be at least 4 characters');
      return;
    }
    
    // Check if username already exists
    if (username === DEFAULT_ADMIN.username) {
      alert('This username is reserved for admin');
      return;
    }
    
    const userAccounts = getUserAccounts();
    if (userAccounts.find(u => u.username === username)) {
      alert('Username already exists');
      return;
    }
    
    // Create account
    const newUser = {
      username: username,
      password: password,
      role: 'viewer',
      createdBy: currentSession.username,
      createdAt: Date.now()
    };
    
    userAccounts.push(newUser);
    saveUserAccounts(userAccounts);
    
    // Clear form
    document.getElementById('createUserForm').reset();
    
    // Refresh list
    refreshUsersList();
    
    // Show success message
    alert(`Viewer account created for ${username}`);
  }
  
  function refreshUsersList() {
    const userAccounts = getUserAccounts();
    const tbody = document.getElementById('usersTableBody');
    
    if (userAccounts.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="5" style="text-align: center; color: var(--gray-400); padding: 2rem;">
            No viewer accounts created yet
          </td>
        </tr>
      `;
      return;
    }
    
    tbody.innerHTML = userAccounts.map(user => `
      <tr>
        <td><strong>${user.username}</strong></td>
        <td><span class="role-badge viewer"><i class="bi bi-eye-fill"></i> Viewer</span></td>
        <td>${user.createdBy}</td>
        <td>${new Date(user.createdAt).toLocaleString()}</td>
        <td>
          <button class="delete-user-btn" onclick="deleteUser('${user.username}')">
            <i class="bi bi-trash-fill"></i>
            Delete
          </button>
        </td>
      </tr>
    `).join('');
  }
  
  function deleteUser(username) {
    if (!confirm(`Are you sure you want to delete user "${username}"?`)) return;
    
    let userAccounts = getUserAccounts();
    userAccounts = userAccounts.filter(u => u.username !== username);
    saveUserAccounts(userAccounts);
    
    // Also force logout if they're currently logged in
    let activeSessions = getActiveSessions();
    const sessionToRemove = activeSessions.find(s => s.username === username);
    if (sessionToRemove) {
      activeSessions = activeSessions.filter(s => s.sessionId !== sessionToRemove.sessionId);
      localStorage.setItem('activeSessions', JSON.stringify(activeSessions));
    }
    
    refreshUsersList();
  }
  
  // 
  // ACTIVE SESSIONS TRACKING (ADMIN ONLY)
  // 
  
  function openActiveSessions() {
    // Close admin dropdown
    document.getElementById('adminDropdownMenu').classList.remove('active');
    
    // Show modal
    document.getElementById('activeSessionsOverlay').classList.add('active');
    
    // Refresh sessions list
    refreshSessionsList();
  }
  
  function closeActiveSessions() {
    document.getElementById('activeSessionsOverlay').classList.remove('active');
  }
  
  function refreshSessionsList() {
    const activeSessions = getActiveSessions();
    const tbody = document.getElementById('sessionsTableBody');
    
    if (activeSessions.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="5" style="text-align: center; color: var(--gray-400); padding: 2rem;">
            No active sessions
          </td>
        </tr>
      `;
      return;
    }
    
    tbody.innerHTML = activeSessions.map(session => {
      const isCurrentSession = session.sessionId === currentSession.sessionId;
      const rowClass = isCurrentSession ? 'current-session' : '';
      
      return `
        <tr class="${rowClass}">
          <td>
            <strong>${session.username}</strong>
            ${isCurrentSession ? ' <span style="color: var(--primary); font-size: 0.75rem;">(You)</span>' : ''}
          </td>
          <td><span class="role-badge ${session.role}">${session.role}</span></td>
          <td>${new Date(session.loginTime).toLocaleString()}</td>
          <td>${new Date(session.lastActivity).toLocaleString()}</td>
          <td>
            <button 
              class="force-logout-btn" 
              onclick="forceLogout('${session.sessionId}')"
              ${isCurrentSession ? 'disabled' : ''}
            >
              <i class="bi bi-box-arrow-right"></i>
              Force Logout
            </button>
          </td>
        </tr>
      `;
    }).join('');
  }
  
  function forceLogout(sessionId) {
    const session = getActiveSessions().find(s => s.sessionId === sessionId);
    if (!session) return;
    
    if (!confirm(`Force logout ${session.username}? They will be logged out immediately.`)) return;
    
    // Remove from active sessions
    let activeSessions = getActiveSessions();
    activeSessions = activeSessions.filter(s => s.sessionId !== sessionId);
    localStorage.setItem('activeSessions', JSON.stringify(activeSessions));
    
    // Refresh list
    refreshSessionsList();
    
    alert(`${session.username} has been logged out`);
  }
  
  // Check periodically for forced logouts
  setInterval(function() {
    if (!currentSession) return;
    
    const activeSessions = getActiveSessions();
    const stillActive = activeSessions.find(s => s.sessionId === currentSession.sessionId);
    
    if (!stillActive) {
      // User was force logged out
      alert('You have been logged out by an administrator');
      performLogout();
    }
  }, 5000); // Check every 5 seconds
  
  @keyframes fadeOut {
    from { opacity: 1; }
    to { opacity: 0; }
  }

</script>

</body>
</html>
